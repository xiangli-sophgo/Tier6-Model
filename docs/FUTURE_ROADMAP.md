# ä»¿çœŸå™¨æ¼”è¿›è·¯çº¿å›¾

**åˆ›å»ºæ—¥æœŸ**: 2025-01-27
**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: Planning

---

## ğŸ“‹ ç›®å½•

1. [å½“å‰æ¶æ„åˆ†æ](#1-å½“å‰æ¶æ„åˆ†æ)
2. [æ¼”è¿›æ–¹å‘æ€»è§ˆ](#2-æ¼”è¿›æ–¹å‘æ€»è§ˆ)
3. [äº‹ä»¶é©±åŠ¨ä»¿çœŸè®¾è®¡](#3-äº‹ä»¶é©±åŠ¨ä»¿çœŸè®¾è®¡)
4. [å…¶ä»–å¢å¼ºæ–¹å‘](#4-å…¶ä»–å¢å¼ºæ–¹å‘)
5. [å®æ–½è·¯å¾„å»ºè®®](#5-å®æ–½è·¯å¾„å»ºè®®)

---

## 1. å½“å‰æ¶æ„åˆ†æ

### 1.1 ç°æœ‰æ¶æ„ç‰¹å¾

å½“å‰ä»¿çœŸå™¨é‡‡ç”¨ **é™æ€æ•°å­¦å»ºæ¨¡ + é¡ºåºæ—¶é—´æ¨è¿›** çš„æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å½“å‰ä»¿çœŸæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Evaluator  â”‚â”€â”€â”€â–¶â”‚  Simulator  â”‚â”€â”€â”€â–¶â”‚   Gantt     â”‚         â”‚
â”‚  â”‚  (æ•°å­¦å»ºæ¨¡) â”‚    â”‚ (é¡ºåºæ¨è¿›)  â”‚    â”‚  Builder    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚        â”‚                  â”‚                                     â”‚
â”‚        â–¼                  â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ GEMM/FA2/   â”‚    â”‚ H2Dâ†’Prefill â”‚                            â”‚
â”‚  â”‚ Comm å»¶è¿Ÿ   â”‚    â”‚ â†’Decodeâ†’D2H â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶ï¼š**

| ç»„ä»¶ | èŒè´£ | å®ç°æ–¹å¼ |
|------|------|----------|
| `Evaluator` | è®¡ç®—å•ä¸ªç®—å­çš„å»¶è¿Ÿ | æ•°å­¦å…¬å¼ + Tile æœç´¢ |
| `Simulator` | ç¼–æ’æ‰§è¡Œé¡ºåºï¼Œè®¡ç®—æ—¶é—´çº¿ | å›ºå®šé˜¶æ®µé¡ºåºæ‰§è¡Œ |
| `ChipState` | ç»´æŠ¤èŠ¯ç‰‡çŠ¶æ€ | current_time, compute_idle_at, network_idle_at |
| `GanttBuilder` | è®°å½•ä»»åŠ¡æ—¶é—´çº¿ | äº‹åæ”¶é›†ï¼Œç”¨äºå¯è§†åŒ– |

### 1.2 ç°æœ‰æ¶æ„çš„ä¼˜åŠ¿

- **ç®€å•ç›´è§‚**ï¼šä»£ç æµç¨‹æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œè°ƒè¯•
- **æ€§èƒ½é«˜æ•ˆ**ï¼šè¯„ä¼°ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- **åŸºæœ¬å‡†ç¡®**ï¼šå¯¹äºç®€å•å¹¶è¡Œç­–ç•¥ï¼Œè¯¯å·®å¯æ¥å—

### 1.3 ç°æœ‰æ¶æ„çš„å±€é™

| å±€é™ | å…·ä½“è¡¨ç° | å½±å“ |
|------|----------|------|
| **åŒæ­¥æ¨è¿›** | æ‰€æœ‰èŠ¯ç‰‡æŒ‰ç›¸åŒæ­¥è°ƒæ¨è¿›æ—¶é—´ | æ— æ³•ç²¾ç¡®æ¨¡æ‹Ÿå¼‚æ­¥æ‰§è¡Œ |
| **é‡å ç®€åŒ–** | è®¡ç®—-é€šä¿¡é‡å ç”¨ç®€å•å…¬å¼ä¼°ç®— | é‡å æ”¶ç›Šä¼°è®¡ä¸å‡† |
| **PP æ°”æ³¡ç²—ç³™** | æ°”æ³¡æ—¶é—´åŸºäºä¸Šä¸€ stage å®Œæˆæ—¶é—´ | å¾®æ‰¹æ¬¡è°ƒåº¦æ— æ³•å»ºæ¨¡ |
| **ä¾èµ–éšå¼** | ç®—å­é—´ä¾èµ–é€šè¿‡æ‰§è¡Œé¡ºåºéšå¼è¡¨è¾¾ | éš¾ä»¥æ”¯æŒå¤æ‚è°ƒåº¦ç­–ç•¥ |

---

## 2. æ¼”è¿›æ–¹å‘æ€»è§ˆ

### 2.1 å¢å¼ºç»´åº¦

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ä»¿çœŸç²¾åº¦æå‡       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œæ¨¡å‹     â”‚    â”‚  ç¡¬ä»¶å»ºæ¨¡     â”‚    â”‚  ç³»ç»Ÿç‰¹æ€§     â”‚
â”‚  ç²¾ç»†åŒ–       â”‚    â”‚  ç²¾ç»†åŒ–       â”‚    â”‚  ç²¾ç»†åŒ–       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â€¢ äº‹ä»¶é©±åŠ¨ä»¿çœŸ       â€¢ å†…å­˜å±‚æ¬¡å»ºæ¨¡       â€¢ é‡åŒ–æ”¯æŒ
â€¢ è®¡ç®—-é€šä¿¡é‡å       â€¢ NoC å»ºæ¨¡          â€¢ åŠ¨æ€å½¢çŠ¶
â€¢ Kernel Launch     â€¢ Bank å†²çª         â€¢ KV Cache ç®¡ç†
â€¢ å¤š Stream         â€¢ åŠŸè€—å»ºæ¨¡          â€¢ Continuous Batching
```

### 2.2 ä¼˜å…ˆçº§çŸ©é˜µ

| æ–¹å‘ | ä»·å€¼ | å¤æ‚åº¦ | ä¼˜å…ˆçº§ | ä¾èµ– |
|------|------|--------|--------|------|
| **äº‹ä»¶é©±åŠ¨ä»¿çœŸ** | â­â­â­â­â­ | â­â­â­â­ | **P0** | æ—  |
| è®¡ç®—-é€šä¿¡é‡å  | â­â­â­â­â­ | â­â­â­ | **P0** | äº‹ä»¶é©±åŠ¨ |
| Kernel Launch å¼€é”€ | â­â­â­â­ | â­â­ | P1 | æ—  |
| å†…å­˜å±‚æ¬¡å»ºæ¨¡ | â­â­â­â­ | â­â­â­â­ | P1 | æ—  |
| é‡åŒ–å»ºæ¨¡ | â­â­â­â­ | â­â­ | P1 | æ—  |
| ç½‘ç»œæ‹¥å¡å»ºæ¨¡ | â­â­â­ | â­â­â­ | P2 | äº‹ä»¶é©±åŠ¨ |
| åŠ¨æ€å½¢çŠ¶/Batching | â­â­â­â­ | â­â­â­â­ | P2 | äº‹ä»¶é©±åŠ¨ |
| åŠŸè€—å»ºæ¨¡ | â­â­ | â­â­â­ | P3 | å†…å­˜å±‚æ¬¡ |

---

## 3. äº‹ä»¶é©±åŠ¨ä»¿çœŸè®¾è®¡

### 3.1 è®¾è®¡ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**ï¼šå°†"é¡ºåºæ—¶é—´æ¨è¿›"æ”¹ä¸º"äº‹ä»¶é©±åŠ¨æ—¶é—´æ¨è¿›"ï¼Œæ”¯æŒçœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œæ¨¡æ‹Ÿã€‚

**å…·ä½“ç›®æ ‡**ï¼š
1. å¤šä¸ªèŠ¯ç‰‡å¯ä»¥ç‹¬ç«‹æ¨è¿›å„è‡ªçš„æ—¶é—´çº¿
2. ç²¾ç¡®å»ºæ¨¡è®¡ç®—-é€šä¿¡çš„é‡å æ‰§è¡Œ
3. æ”¯æŒå¤æ‚çš„æµæ°´çº¿å¹¶è¡Œç­–ç•¥ï¼ˆGPipeã€PipeDream 1F1Bï¼‰
4. ç²¾ç¡®è®¡ç®— PP æ°”æ³¡å’Œèµ„æºåˆ©ç”¨ç‡

### 3.2 æ ¸å¿ƒæ¦‚å¿µ

#### 3.2.1 äº‹ä»¶ (Event)

äº‹ä»¶æ˜¯ä»¿çœŸçš„åŸºæœ¬å•ä½ï¼Œè¡¨ç¤º"æŸä¸ªæ—¶åˆ»å‘ç”Ÿçš„æŸä»¶äº‹"ã€‚

**äº‹ä»¶çš„åŸºæœ¬å±æ€§**ï¼š

| å±æ€§ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `timestamp` | float | äº‹ä»¶å‘ç”Ÿçš„ä»¿çœŸæ—¶é—´ï¼ˆå¾®ç§’ï¼‰ |
| `event_type` | EventType | äº‹ä»¶ç±»å‹ |
| `chip_id` | str | äº‹ä»¶å‘ç”Ÿçš„èŠ¯ç‰‡ |
| `resource_type` | ResourceType | å ç”¨çš„èµ„æºç±»å‹ï¼ˆè®¡ç®—/ç½‘ç»œï¼‰ |
| `operator` | Operator | ç›¸å…³çš„ç®—å­ |
| `metadata` | dict | å…¶ä»–å…ƒæ•°æ®ï¼ˆå±‚ç´¢å¼•ã€token ç´¢å¼•ç­‰ï¼‰ |

**äº‹ä»¶ç±»å‹å®šä¹‰**ï¼š

```
äº‹ä»¶ç±»å‹å±‚æ¬¡ç»“æ„ï¼š

EventType
â”œâ”€â”€ COMPUTE_START       # è®¡ç®—å¼€å§‹
â”œâ”€â”€ COMPUTE_END         # è®¡ç®—ç»“æŸ
â”œâ”€â”€ COMM_START          # é€šä¿¡å¼€å§‹
â”œâ”€â”€ COMM_END            # é€šä¿¡ç»“æŸ
â”œâ”€â”€ MEMORY_START        # å†…å­˜æ“ä½œå¼€å§‹
â”œâ”€â”€ MEMORY_END          # å†…å­˜æ“ä½œç»“æŸ
â”œâ”€â”€ LAYER_COMPLETE      # ä¸€å±‚å¤„ç†å®Œæˆ
â”œâ”€â”€ STAGE_READY         # PP stage å‡†å¤‡å¥½æ¥æ”¶æ•°æ®
â”œâ”€â”€ BATCH_COMPLETE      # ä¸€ä¸ª micro-batch å®Œæˆ
â””â”€â”€ SYNC_POINT          # åŒæ­¥ç‚¹ï¼ˆbarrierï¼‰
```

#### 3.2.2 èµ„æº (Resource)

èµ„æºæ˜¯å¯ä»¥è¢«äº‹ä»¶å ç”¨çš„å®ä½“ï¼ŒåŒä¸€èµ„æºåŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªä»»åŠ¡ä½¿ç”¨ã€‚

**èµ„æºç±»å‹**ï¼š

| èµ„æºç±»å‹ | è¯´æ˜ | æ•°é‡ï¼ˆæ¯èŠ¯ç‰‡ï¼‰ |
|----------|------|----------------|
| `COMPUTE` | è®¡ç®—å•å…ƒï¼ˆTensor Coreï¼‰ | 1ï¼ˆå¯æ‰©å±•ä¸ºå¤šä¸ªï¼‰ |
| `NETWORK` | ç½‘ç»œæ¥å£ | 1ï¼ˆå¯æ‰©å±•ä¸ºå¤šä¸ª portï¼‰ |
| `MEMORY_BUS` | å†…å­˜æ€»çº¿ | 1 |

**èµ„æºçŠ¶æ€**ï¼š
- `idle_at`: èµ„æºä¸‹æ¬¡ç©ºé—²çš„æ—¶é—´ç‚¹
- `current_task`: å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰

#### 3.2.3 ä¾èµ–å…³ç³» (Dependency)

äº‹ä»¶ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå†³å®šäº†äº‹ä»¶çš„è§¦å‘é¡ºåºã€‚

**ä¾èµ–ç±»å‹**ï¼š

| ä¾èµ–ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|----------|------|------|
| **æ•°æ®ä¾èµ–** | åç»­æ“ä½œéœ€è¦å‰åºæ“ä½œçš„è¾“å‡º | GEMM éœ€è¦ç­‰ RMSNorm å®Œæˆ |
| **èµ„æºä¾èµ–** | éœ€è¦ç­‰å¾…èµ„æºç©ºé—² | ä¸‹ä¸€ä¸ª GEMM éœ€è¦ç­‰å½“å‰ GEMM å®Œæˆ |
| **åŒæ­¥ä¾èµ–** | éœ€è¦ç­‰å¾…å¤šä¸ªæ“ä½œéƒ½å®Œæˆ | AllReduce éœ€è¦ç­‰æ‰€æœ‰èŠ¯ç‰‡éƒ½åˆ°è¾¾ |
| **é€šä¿¡ä¾èµ–** | PP å‰å‘ä¼ é€’éœ€è¦ç­‰ä¸Šä¸€ stage | Stage 1 ç­‰ Stage 0 å‘é€æ¿€æ´»å€¼ |

### 3.3 äº‹ä»¶è°ƒåº¦å™¨è®¾è®¡

#### 3.3.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº‹ä»¶é©±åŠ¨ä»¿çœŸå™¨                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Event     â”‚    â”‚   Event     â”‚    â”‚   Resource  â”‚         â”‚
â”‚  â”‚   Queue     â”‚â—€â”€â”€â–¶â”‚  Scheduler  â”‚â—€â”€â”€â–¶â”‚   Manager   â”‚         â”‚
â”‚  â”‚ (ä¼˜å…ˆé˜Ÿåˆ—)  â”‚    â”‚  (è°ƒåº¦æ ¸å¿ƒ) â”‚    â”‚ (èµ„æºåˆ†é…)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚        â”‚                  â”‚                   â”‚                 â”‚
â”‚        â”‚                  â–¼                   â”‚                 â”‚
â”‚        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                 â”‚
â”‚        â”‚          â”‚   Event     â”‚             â”‚                 â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Handlers   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                   â”‚ (äº‹ä»¶å¤„ç†)  â”‚                               â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â–¼                                      â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                   â”‚   Gantt     â”‚                               â”‚
â”‚                   â”‚  Collector  â”‚                               â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.2 äº‹ä»¶é˜Ÿåˆ— (Event Queue)

**æ•°æ®ç»“æ„**ï¼šä¼˜å…ˆé˜Ÿåˆ—ï¼ˆæœ€å°å †ï¼‰ï¼ŒæŒ‰ timestamp æ’åº

**å…³é”®æ“ä½œ**ï¼š
- `push(event)`: æ’å…¥æ–°äº‹ä»¶ï¼ŒO(log n)
- `pop()`: å–å‡ºæ—¶é—´æœ€æ—©çš„äº‹ä»¶ï¼ŒO(log n)
- `peek()`: æŸ¥çœ‹æœ€æ—©äº‹ä»¶ä½†ä¸ç§»é™¤ï¼ŒO(1)

**æ’åºè§„åˆ™**ï¼š
1. é¦–å…ˆæŒ‰ `timestamp` å‡åº
2. ç›¸åŒæ—¶é—´æ—¶ï¼ŒæŒ‰ä¼˜å…ˆçº§ï¼ˆCOMPUTE_END > COMM_END > *_STARTï¼‰
3. ä»ç›¸åŒæ—¶ï¼ŒæŒ‰äº‹ä»¶åˆ›å»ºé¡ºåºï¼ˆä¿è¯ç¡®å®šæ€§ï¼‰

#### 3.3.3 èµ„æºç®¡ç†å™¨ (Resource Manager)

**èŒè´£**ï¼š
1. è¿½è¸ªæ¯ä¸ªèŠ¯ç‰‡æ¯ç§èµ„æºçš„çŠ¶æ€
2. åˆ¤æ–­èµ„æºæ˜¯å¦å¯ç”¨
3. åˆ†é…å’Œé‡Šæ”¾èµ„æº

**èµ„æºåˆ†é…é€»è¾‘**ï¼š

```
è¯·æ±‚èµ„æº(chip_id, resource_type, start_time, duration):

    1. è·å–èµ„æºå½“å‰çŠ¶æ€
       resource = get_resource(chip_id, resource_type)

    2. è®¡ç®—å®é™…å¼€å§‹æ—¶é—´
       actual_start = max(start_time, resource.idle_at)

    3. å¦‚æœéœ€è¦ç­‰å¾…ï¼Œè®°å½•ç­‰å¾…æ—¶é—´ï¼ˆç”¨äºç»Ÿè®¡æ°”æ³¡ï¼‰
       if actual_start > start_time:
           record_bubble(chip_id, start_time, actual_start)

    4. æ›´æ–°èµ„æºçŠ¶æ€
       resource.idle_at = actual_start + duration

    5. è¿”å›å®é™…å¼€å§‹å’Œç»“æŸæ—¶é—´
       return (actual_start, actual_start + duration)
```

#### 3.3.4 äº‹ä»¶å¤„ç†å™¨ (Event Handlers)

æ¯ç§äº‹ä»¶ç±»å‹æœ‰å¯¹åº”çš„å¤„ç†å™¨ï¼Œå¤„ç†å™¨å†³å®šï¼š
1. å¦‚ä½•æ›´æ–°çŠ¶æ€
2. äº§ç”Ÿå“ªäº›åç»­äº‹ä»¶

**COMPUTE_START å¤„ç†é€»è¾‘**ï¼š

```
å¤„ç† COMPUTE_START äº‹ä»¶:

    è¾“å…¥: event (åŒ…å« chip_id, operator, timestamp)

    1. ä» Evaluator è·å–ç®—å­æ‰§è¡Œæ—¶é—´
       duration = evaluator.get_latency(event.operator)

    2. è¯·æ±‚è®¡ç®—èµ„æº
       actual_start, actual_end = resource_manager.request(
           chip_id = event.chip_id,
           resource_type = COMPUTE,
           start_time = event.timestamp,
           duration = duration
       )

    3. è®°å½•åˆ° Gantt å›¾
       gantt_collector.add_task(
           name = event.operator.name,
           start = actual_start,
           end = actual_end,
           chip_id = event.chip_id
       )

    4. åˆ›å»º COMPUTE_END äº‹ä»¶
       end_event = Event(
           timestamp = actual_end,
           event_type = COMPUTE_END,
           chip_id = event.chip_id,
           operator = event.operator
       )
       event_queue.push(end_event)
```

**COMPUTE_END å¤„ç†é€»è¾‘**ï¼š

```
å¤„ç† COMPUTE_END äº‹ä»¶:

    è¾“å…¥: event (åŒ…å« chip_id, operator, timestamp)

    1. æ£€æŸ¥æ˜¯å¦æœ‰åç»­ç®—å­
       next_ops = dependency_graph.get_successors(event.operator)

    2. å¯¹äºæ¯ä¸ªåç»­ç®—å­ï¼Œæ£€æŸ¥å…¶æ‰€æœ‰å‰é©±æ˜¯å¦éƒ½å·²å®Œæˆ
       for next_op in next_ops:
           predecessors = dependency_graph.get_predecessors(next_op)
           all_done = all(is_completed(p) for p in predecessors)

           if all_done:
               # åˆ›å»ºä¸‹ä¸€ä¸ªè®¡ç®—å¼€å§‹äº‹ä»¶
               if is_compute_op(next_op):
                   create_compute_start_event(next_op, event.timestamp)
               elif is_comm_op(next_op):
                   create_comm_start_event(next_op, event.timestamp)

    3. æ ‡è®°å½“å‰ç®—å­ä¸ºå·²å®Œæˆ
       mark_completed(event.operator)

    4. æ£€æŸ¥æ˜¯å¦è§¦å‘å±‚å®Œæˆ
       if is_last_op_in_layer(event.operator):
           create_layer_complete_event(...)
```

**COMM_START å¤„ç†é€»è¾‘**ï¼š

```
å¤„ç† COMM_START äº‹ä»¶:

    è¾“å…¥: event (åŒ…å« å‚ä¸çš„æ‰€æœ‰ chip_ids, comm_op, timestamp)

    1. æ£€æŸ¥æ‰€æœ‰å‚ä¸è€…æ˜¯å¦éƒ½å·²åˆ°è¾¾åŒæ­¥ç‚¹
       for chip_id in event.participating_chips:
           if not is_ready_for_comm(chip_id):
               # è¿˜æœ‰èŠ¯ç‰‡æ²¡å‡†å¤‡å¥½ï¼Œè®°å½•å½“å‰èŠ¯ç‰‡ç­‰å¾…
               record_comm_wait(event.chip_id, timestamp)
               return  # æš‚ä¸å¤„ç†ï¼Œç­‰å¾…å…¶ä»–èŠ¯ç‰‡è§¦å‘

    2. æ‰€æœ‰èŠ¯ç‰‡éƒ½å°±ç»ªï¼Œå¼€å§‹é€šä¿¡
       # æ‰¾åˆ°æœ€æ™šåˆ°è¾¾çš„æ—¶é—´ä½œä¸ºå®é™…å¼€å§‹æ—¶é—´
       actual_start = max(arrival_times[chip] for chip in participating_chips)

    3. è·å–é€šä¿¡å»¶è¿Ÿ
       duration = evaluator.get_comm_latency(event.comm_op)

    4. ä¸ºæ‰€æœ‰å‚ä¸èŠ¯ç‰‡è¯·æ±‚ç½‘ç»œèµ„æº
       for chip_id in participating_chips:
           resource_manager.request(
               chip_id = chip_id,
               resource_type = NETWORK,
               start_time = actual_start,
               duration = duration
           )

    5. è®°å½•åˆ° Gantt å›¾ï¼ˆæ‰€æœ‰èŠ¯ç‰‡ï¼‰
       for chip_id in participating_chips:
           gantt_collector.add_task(...)

    6. åˆ›å»º COMM_END äº‹ä»¶
       event_queue.push(COMM_END event at actual_start + duration)
```

### 3.4 ä¾èµ–å›¾æ„å»º

#### 3.4.1 ç®—å­çº§ä¾èµ–

æ¯ä¸€å±‚å†…éƒ¨çš„ç®—å­ä¾èµ–å…³ç³»ï¼š

```
Transformer Layer ä¾èµ–å›¾ (MHA + FFN):

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  RMSNorm    â”‚
                    â”‚  (Input)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚              â”‚
            â–¼              â–¼              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  Q Proj â”‚    â”‚  K Proj â”‚    â”‚  V Proj â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚              â”‚              â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  TP AllGath â”‚ (å¦‚æœ SP å¯ç”¨)
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Attention  â”‚
                    â”‚  (QK, SV)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  O Proj     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ TP AllReduceâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  RMSNorm    â”‚
                    â”‚  (FFN)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                             â”‚
            â–¼                             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Gate/Up â”‚                   â”‚   Up    â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚                             â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Down      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ TP AllReduceâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Output    â”‚
                    â”‚ (Residual)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4.2 è·¨å±‚ä¾èµ–

PP (Pipeline Parallelism) åœºæ™¯ä¸‹çš„è·¨ stage ä¾èµ–ï¼š

```
PP Stage é—´ä¾èµ– (PP=2, 4 å±‚):

Stage 0 (Layer 0-1)              Stage 1 (Layer 2-3)
      â”‚                                â”‚
      â–¼                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  Layer 0  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                          â”‚
      â”‚                                â”‚
      â–¼                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  Layer 1  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                          â”‚
      â”‚                                â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€ P2P Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚
      â”‚                                â–¼
      â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                          â”‚  Layer 2  â”‚
      â”‚                          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚                                â”‚
      â”‚                                â–¼
      â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                          â”‚  Layer 3  â”‚
      â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4.3 MoE ç‰¹æ®Šä¾èµ–

MoE å±‚çš„ Dispatch/Compute/Combine ä¾èµ–ï¼š

```
MoE å±‚ä¾èµ–å›¾:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gate/Routerâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     TP/EP é€šä¿¡ç»„ç»‡
â”‚ EP Dispatch â”‚â—€â”€â”€â”€â”€token é‡åˆ†å¸ƒåˆ°å¯¹åº” expert æ‰€åœ¨èŠ¯ç‰‡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€ ... â”€â”€â”€â”
       â”‚              â”‚              â”‚           â”‚
       â–¼              â–¼              â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Expert 0  â”‚  â”‚ Expert 1  â”‚  â”‚ Expert 2  â”‚  â”‚ Expert N  â”‚
â”‚   FFN     â”‚  â”‚   FFN     â”‚  â”‚   FFN     â”‚  â”‚   FFN     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚              â”‚              â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ EP Combine  â”‚â—€â”€â”€â”€â”€ç»“æœèšåˆ
                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚Shared Expertâ”‚ (å¦‚æœæœ‰)
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.5 è®¡ç®—-é€šä¿¡é‡å å»ºæ¨¡

#### 3.5.1 é‡å çš„æœ¬è´¨

è®¡ç®—å’Œé€šä¿¡å¯ä»¥é‡å çš„å‰ææ˜¯ï¼š
1. **èµ„æºç‹¬ç«‹**ï¼šè®¡ç®—ä½¿ç”¨ Tensor Coreï¼Œé€šä¿¡ä½¿ç”¨ NIC/NVLink
2. **æ•°æ®æ— ä¾èµ–**ï¼šé€šä¿¡çš„æ•°æ®ä¸ä¾èµ–æ­£åœ¨è¿›è¡Œçš„è®¡ç®—ç»“æœ

#### 3.5.2 é‡å åœºæ™¯åˆ†æ

**åœºæ™¯ 1ï¼šTP AllReduce ä¸ä¸‹ä¸€å±‚ RMSNorm é‡å **

```
ä¼ ç»Ÿé¡ºåºæ‰§è¡Œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   O Proj       â”‚â”‚  TP AllReduce  â”‚â”‚    RMSNorm     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                       æ— æ³•é‡å 

é‡å æ‰§è¡Œï¼ˆéœ€è¦ç‰¹æ®Šç®—æ³•æ”¯æŒï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   O Proj       â”‚â”‚  TP AllReduce (åˆ†å—)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ ç¬¬ä¸€å—å®Œæˆå³å¯å¼€å§‹
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  RMSNorm (æµæ°´çº¿)               â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    é‡å éƒ¨åˆ†
```

**åœºæ™¯ 2ï¼šMoE TBO (Tensor-Bus Overlap)**

```
æ—  TBO:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dispatch â”‚â”‚       Expert 0-N Compute         â”‚â”‚ Combine  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ‰ TBO:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dispatch â”‚â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
              â–¼ æ•°æ®åˆ°è¾¾å³å¼€å§‹è®¡ç®—
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Expert 0   â”‚â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
              â”‚  Expert 1   â”‚â”¼â”€â”€â”
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚ è®¡ç®—å®Œæˆå³å¼€å§‹å‘é€
                    ...      â”‚  â–¼
                             â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚â”‚ Combine  â”‚ (æµæ°´çº¿)
                             â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

#### 3.5.3 é‡å çš„äº‹ä»¶å»ºæ¨¡

**å…³é”®**ï¼šå¼•å…¥"éƒ¨åˆ†å®Œæˆ"äº‹ä»¶

```
äº‹ä»¶ç±»å‹æ‰©å±•:

COMPUTE_CHUNK_COMPLETE    # è®¡ç®—å—å®Œæˆï¼ˆç”¨äºåˆ†å—è®¡ç®—ï¼‰
COMM_CHUNK_COMPLETE       # é€šä¿¡å—å®Œæˆï¼ˆç”¨äºåˆ†å—ä¼ è¾“ï¼‰
PARTIAL_DATA_READY        # éƒ¨åˆ†æ•°æ®å°±ç»ªï¼ˆè§¦å‘æµæ°´çº¿ä¸‹ä¸€é˜¶æ®µï¼‰
```

**é‡å è°ƒåº¦é€»è¾‘**ï¼š

```
å¤„ç† COMPUTE_CHUNK_COMPLETE äº‹ä»¶:

    1. æ£€æŸ¥æ˜¯å¦æœ‰ä¾èµ–æ­¤å—çš„é€šä¿¡
       if has_dependent_comm(chunk):
           # å¯åŠ¨è¯¥å—çš„é€šä¿¡ï¼ˆä¸ç­‰å¾…å®Œæ•´è®¡ç®—å®Œæˆï¼‰
           create_comm_chunk_start(chunk, timestamp)

    2. ç»§ç»­ä¸‹ä¸€å—è®¡ç®—
       if has_more_chunks():
           create_compute_chunk_start(next_chunk, timestamp)
```

### 3.6 æµæ°´çº¿å¹¶è¡Œè°ƒåº¦

#### 3.6.1 GPipe è°ƒåº¦

**ç‰¹ç‚¹**ï¼šæ‰€æœ‰ micro-batch çš„å‰å‘ä¼ é€’å®Œæˆåï¼Œå†è¿›è¡Œåå‘ä¼ é€’

```
GPipe æ—¶é—´çº¿ (PP=4, micro-batch=4):

Stage 0: [F0][F1][F2][F3]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[B3][B2][B1][B0]
Stage 1:    [F0][F1][F2][F3]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[B3][B2][B1][B0]
Stage 2:       [F0][F1][F2][F3]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[B3][B2][B1][B0]
Stage 3:          [F0][F1][F2][F3]â”€â”€â”€â”€â”€â”€â”€â”€[B3][B2][B1][B0]
                                   â”‚
                                   â””â”€ å¤§é‡ bubble
```

**äº‹ä»¶å»ºæ¨¡**ï¼š
- æ¯ä¸ª micro-batch çš„å‰å‘ä½œä¸ºç‹¬ç«‹äº‹ä»¶é“¾
- Stage N+1 çš„ F_i ä¾èµ– Stage N çš„ F_i å®Œæˆ
- åå‘ä¼ é€’ä¾èµ–æ‰€æœ‰å‰å‘å®Œæˆ

#### 3.6.2 1F1B (PipeDream) è°ƒåº¦

**ç‰¹ç‚¹**ï¼šäº¤æ›¿è¿›è¡Œå‰å‘å’Œåå‘ï¼Œå‡å°‘ bubble

```
1F1B æ—¶é—´çº¿ (PP=4, micro-batch=8):

Stage 0: [F0][F1][F2][F3][B0][F4][B1][F5][B2][F6][B3][F7][B4][B5][B6][B7]
Stage 1:    [F0][F1][F2][B0][F3][B1][F4][B2][F5][B3][F6][B4][F7][B5][B6][B7]
Stage 2:       [F0][F1][B0][F2][B1][F3][B2][F4][B3][F5][B4][F6][B5][F7][B6][B7]
Stage 3:          [F0][B0][F1][B1][F2][B2][F3][B3][F4][B4][F5][B5][F6][B6][F7][B7]
                     â”‚
                     â””â”€ ç¨³å®šçŠ¶æ€ï¼šäº¤æ›¿ F/Bï¼Œå‡å°‘ bubble
```

**äº‹ä»¶å»ºæ¨¡**ï¼š
- éœ€è¦è¿½è¸ªæ¯ä¸ª stage çš„"in-flight micro-batch æ•°é‡"
- åå‘ä¼ é€’çš„è§¦å‘ä¸å†ç­‰å¾…æ‰€æœ‰å‰å‘å®Œæˆ
- è°ƒåº¦å†³ç­–ï¼šå½“å‰æ‰§è¡Œ F è¿˜æ˜¯ Bï¼Ÿ

```
1F1B è°ƒåº¦å†³ç­–é€»è¾‘:

åœ¨ Stage i å®Œæˆä¸€ä¸ªæ“ä½œåï¼Œå†³å®šä¸‹ä¸€æ­¥:

    1. è®¡ç®—å½“å‰ in-flight çš„ micro-batch æ•°é‡
       in_flight = num_forward_done - num_backward_done

    2. çƒ­èº«é˜¶æ®µ (in_flight < PP - stage_id)
       â†’ æ‰§è¡Œ Forward

    3. ç¨³å®šé˜¶æ®µ (in_flight == PP - stage_id)
       â†’ äº¤æ›¿æ‰§è¡Œ Forward å’Œ Backward

    4. æ”¶å°¾é˜¶æ®µ (æ²¡æœ‰æ›´å¤š Forward)
       â†’ åªæ‰§è¡Œ Backward
```

### 3.7 ä»¿çœŸä¸»å¾ªç¯

```
äº‹ä»¶é©±åŠ¨ä»¿çœŸä¸»å¾ªç¯:

åˆå§‹åŒ–:
    1. æ„å»ºä¾èµ–å›¾
       dependency_graph = build_dependency_graph(model, parallelism)

    2. åˆå§‹åŒ–èµ„æºç®¡ç†å™¨
       resource_manager = ResourceManager(chip_states)

    3. åˆå§‹åŒ–äº‹ä»¶é˜Ÿåˆ—
       event_queue = PriorityQueue()

    4. æ·»åŠ åˆå§‹äº‹ä»¶
       # H2D ä¼ è¾“å®Œæˆåï¼ŒPP Stage 0 çš„ç¬¬ä¸€å±‚å¼€å§‹
       for micro_batch in range(num_micro_batches):
           event_queue.push(Event(
               timestamp = h2d_end_time + micro_batch * stagger_delay,
               event_type = COMPUTE_START,
               chip_id = stage_0_chips[0],
               operator = first_layer_first_op,
               metadata = {'micro_batch': micro_batch}
           ))

ä¸»å¾ªç¯:
    while not event_queue.empty():
        # 1. å–å‡ºæœ€æ—©çš„äº‹ä»¶
        event = event_queue.pop()

        # 2. æ¨è¿›ä»¿çœŸæ—¶é—´
        current_sim_time = event.timestamp

        # 3. æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†å™¨
        handler = get_handler(event.event_type)
        new_events = handler.handle(event, resource_manager, dependency_graph)

        # 4. å°†äº§ç”Ÿçš„æ–°äº‹ä»¶åŠ å…¥é˜Ÿåˆ—
        for new_event in new_events:
            event_queue.push(new_event)

        # 5. è®°å½•åˆ° Gantt å›¾ï¼ˆå¦‚æœæ˜¯ç»“æŸäº‹ä»¶ï¼‰
        if is_end_event(event):
            gantt_collector.record(event)

ç»ˆæ­¢æ¡ä»¶:
    - äº‹ä»¶é˜Ÿåˆ—ä¸ºç©º
    - æˆ–è¾¾åˆ°æœ€å¤§ä»¿çœŸæ—¶é—´
    - æˆ–æ‰€æœ‰è¾“å‡º token éƒ½å·²ç”Ÿæˆ
```

### 3.8 æ­£ç¡®æ€§éªŒè¯

#### 3.8.1 ä¸å½“å‰å®ç°å¯¹æ¯”

åœ¨ç®€å•åœºæ™¯ä¸‹ï¼Œäº‹ä»¶é©±åŠ¨ä»¿çœŸåº”è¯¥ä¸å½“å‰é¡ºåºä»¿çœŸç»“æœä¸€è‡´ï¼š

| åœºæ™¯ | éªŒè¯æ–¹æ³• |
|------|----------|
| å•èŠ¯ç‰‡æ— å¹¶è¡Œ | æ€»æ—¶é—´åº”è¯¥å®Œå…¨ç›¸ç­‰ |
| çº¯ TP å¹¶è¡Œ | è®¡ç®—æ—¶é—´ç›¸ç­‰ï¼Œé€šä¿¡æ—¶é—´ç›¸è¿‘ |
| çº¯ PP å¹¶è¡Œ | æ€»æ—¶é—´ç›¸è¿‘ï¼Œæ°”æ³¡æ¯”ä¾‹å¯èƒ½æ›´å‡†ç¡® |

#### 3.8.2 æç«¯æƒ…å†µæµ‹è¯•

- **é›¶é€šä¿¡å»¶è¿Ÿ**ï¼šåº”è¯¥é€€åŒ–ä¸ºé¡ºåºæ‰§è¡Œ
- **æ— é™å¸¦å®½**ï¼šé€šä¿¡ä¸åº”æˆä¸ºç“¶é¢ˆ
- **å• micro-batch**ï¼š1F1B åº”è¯¥é€€åŒ–ä¸º GPipe

#### 3.8.3 æ€§èƒ½å›å½’æµ‹è¯•

å»ºç«‹åŸºå‡†æµ‹è¯•é›†ï¼Œç¡®ä¿ï¼š
1. ä»¿çœŸç»“æœçš„ç¡®å®šæ€§ï¼ˆç›¸åŒè¾“å…¥ â†’ ç›¸åŒè¾“å‡ºï¼‰
2. ä»¿çœŸæ€§èƒ½å¯æ¥å—ï¼ˆä¸æ¯”å½“å‰æ…¢å¤ªå¤šï¼‰

---

## 4. å…¶ä»–å¢å¼ºæ–¹å‘

### 4.1 Kernel Launch å¼€é”€å»ºæ¨¡

**èƒŒæ™¯**ï¼šæ¯ä¸ª GPU kernel éƒ½æœ‰å¯åŠ¨å¼€é”€ï¼ˆçº¦ 2-10 å¾®ç§’ï¼‰ï¼Œå¯¹å°ç®—å­å½±å“æ˜¾è‘—ã€‚

**å»ºæ¨¡æ–¹å¼**ï¼š
- ä¸ºæ¯ä¸ªç®—å­æ·»åŠ å›ºå®šçš„ launch å¼€é”€
- è€ƒè™‘ kernel fusion å¯¹ launch æ¬¡æ•°çš„å‡å°‘

**å½±å“**ï¼š
- Decode é˜¶æ®µï¼ˆå° batchï¼‰çš„ä¼°è®¡ä¼šæ›´å‡†ç¡®
- RMSNormã€Softmax ç­‰å°ç®—å­çš„å æ¯”ä¼šæ›´çœŸå®

### 4.2 å†…å­˜å±‚æ¬¡å»ºæ¨¡

**èƒŒæ™¯**ï¼šå½“å‰å‡è®¾æ‰€æœ‰æ•°æ®éƒ½åœ¨ HBMï¼Œå¿½ç•¥äº† SRAM tiling çš„æ•ˆæœã€‚

**å»ºæ¨¡è¦ç‚¹**ï¼š
- Tile å¤§å°å½±å“ SRAM å¤ç”¨æ¬¡æ•°
- å½“ tile èƒ½å®Œå…¨æ”¾å…¥ SRAM æ—¶ï¼ŒHBM æµé‡å‡å°‘
- Bank å†²çªä¼šé™ä½å®é™…å¸¦å®½

### 4.3 é‡åŒ–æ”¯æŒ

**èƒŒæ™¯**ï¼šINT8/FP8 é‡åŒ–æ˜¯å®é™…éƒ¨ç½²çš„å¸¸è§ä¼˜åŒ–ã€‚

**å»ºæ¨¡è¦ç‚¹**ï¼š
- é‡åŒ–åçš„ GEMM ååé‡å˜åŒ–ï¼ˆé€šå¸¸ 2xï¼‰
- Dequant/Requant çš„é¢å¤–å¼€é”€
- æ··åˆç²¾åº¦çš„å¤æ‚æ€§ï¼ˆéƒ¨åˆ†å±‚é‡åŒ–ï¼‰

### 4.4 ç½‘ç»œæ‹¥å¡å»ºæ¨¡

**èƒŒæ™¯**ï¼šå¤šä¸ªé€šä¿¡æµåŒæ—¶ä½¿ç”¨ç½‘ç»œæ—¶ä¼šç«äº‰å¸¦å®½ã€‚

**å»ºæ¨¡è¦ç‚¹**ï¼š
- è¿½è¸ªæ¯æ¡é“¾è·¯çš„å½“å‰è´Ÿè½½
- å®ç° fair-share æˆ–å…¶ä»–å¸¦å®½åˆ†é…ç­–ç•¥
- è€ƒè™‘äº¤æ¢æœºçš„ç¼“å†²å’Œæ’é˜Ÿå»¶è¿Ÿ

---

## 5. å®æ–½è·¯å¾„å»ºè®®

### 5.1 é˜¶æ®µè§„åˆ’

```
Phase 1: åŸºç¡€äº‹ä»¶ç³»ç»Ÿ                    Phase 2: é«˜çº§ç‰¹æ€§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Event & EventQueue   â”‚              â”‚ â€¢ è®¡ç®—-é€šä¿¡é‡å         â”‚
â”‚ â€¢ Resource Manager     â”‚              â”‚ â€¢ 1F1B è°ƒåº¦æ”¯æŒ        â”‚
â”‚ â€¢ åŸºç¡€ Handler         â”‚    â”€â”€â”€â”€â–¶     â”‚ â€¢ MoE TBO             â”‚
â”‚ â€¢ ä¾èµ–å›¾æ„å»º           â”‚              â”‚ â€¢ åˆ†å—ä¼ è¾“å»ºæ¨¡         â”‚
â”‚ â€¢ ç®€å•åœºæ™¯éªŒè¯         â”‚              â”‚ â€¢ æ€§èƒ½ä¼˜åŒ–             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                      â”‚
           â”‚                                      â”‚
           â–¼                                      â–¼
Phase 3: ç²¾ç»†åŒ–å¢å¼º                      Phase 4: ç”Ÿäº§å°±ç»ª
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Kernel Launch å¼€é”€   â”‚              â”‚ â€¢ å®Œæ•´æµ‹è¯•è¦†ç›–         â”‚
â”‚ â€¢ é‡åŒ–æ”¯æŒ             â”‚    â”€â”€â”€â”€â–¶     â”‚ â€¢ æ€§èƒ½åŸºå‡†             â”‚
â”‚ â€¢ ç½‘ç»œæ‹¥å¡             â”‚              â”‚ â€¢ æ–‡æ¡£å®Œå–„             â”‚
â”‚ â€¢ åŠ¨æ€ Batching        â”‚              â”‚ â€¢ æ–°æ—§æ¨¡å¼åˆ‡æ¢         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é‡Œç¨‹ç¢‘

| é˜¶æ®µ | ç›®æ ‡ | éªŒæ”¶æ ‡å‡† |
|------|------|----------|
| Phase 1 | äº‹ä»¶é©±åŠ¨åŸºç¡€æ¶æ„ | ç®€å•åœºæ™¯ç»“æœä¸å½“å‰å®ç°ä¸€è‡´ |
| Phase 2 | é«˜çº§å¹¶è¡Œç‰¹æ€§ | é‡å åœºæ™¯æ€§èƒ½é¢„æµ‹æ›´å‡†ç¡® |
| Phase 3 | ç²¾ç»†åŒ–å¢å¼º | æ”¯æŒé‡åŒ–ã€åŠ¨æ€ batch ç­‰åœºæ™¯ |
| Phase 4 | ç”Ÿäº§å°±ç»ª | æ–‡æ¡£å®Œå–„ï¼Œå¯åˆ‡æ¢æ–°æ—§æ¨¡å¼ |

### 5.3 é£é™©ä¸ç¼“è§£

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| å¤æ‚åº¦å¤±æ§ | ä¸­ | é«˜ | åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯é˜¶æ®µç‹¬ç«‹éªŒè¯ |
| æ€§èƒ½ä¸‹é™ | ä¸­ | ä¸­ | äº‹ä»¶ç¼“å­˜ï¼Œæƒ°æ€§æ±‚å€¼ |
| è°ƒè¯•å›°éš¾ | é«˜ | ä¸­ | å®Œå–„æ—¥å¿—ï¼Œå¯è§†åŒ–äº‹ä»¶æµ |
| ç»“æœä¸ä¸€è‡´ | ä¸­ | é«˜ | å»ºç«‹å¯¹æ¯”æµ‹è¯•æ¡†æ¶ |

---

## é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| äº‹ä»¶é©±åŠ¨ | Event-Driven | ä»¿çœŸæ¨è¿›ç”±äº‹ä»¶è§¦å‘ï¼Œè€Œéå›ºå®šæ­¥é•¿ |
| ä¼˜å…ˆé˜Ÿåˆ— | Priority Queue | æŒ‰ä¼˜å…ˆçº§ï¼ˆæ­¤å¤„ä¸ºæ—¶é—´ï¼‰æ’åºçš„é˜Ÿåˆ— |
| ä¾èµ–å›¾ | Dependency Graph | æè¿°æ“ä½œé—´ä¾èµ–å…³ç³»çš„æœ‰å‘å›¾ |
| æ°”æ³¡ | Bubble | èµ„æºç©ºé—²ç­‰å¾…çš„æ—¶é—´ |
| å¾®æ‰¹æ¬¡ | Micro-batch | æµæ°´çº¿å¹¶è¡Œä¸­çš„å°æ‰¹æ¬¡ |
| TBO | Tensor-Bus Overlap | è®¡ç®—å’Œé€šä¿¡é‡å ä¼˜åŒ– |

### B. å‚è€ƒèµ„æ–™

1. GPipe: Efficient Training of Giant Neural Networks
2. PipeDream: Generalized Pipeline Parallelism for DNN Training
3. Megatron-LM: Training Multi-Billion Parameter Language Models
4. DeepSpeed: System Optimizations Enable Training Deep Learning Models with Over 100 Billion Parameters
