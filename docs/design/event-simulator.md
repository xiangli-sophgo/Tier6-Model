# äº‹ä»¶é©±åŠ¨ä»¿çœŸå™¨æŠ€æœ¯æ–‡æ¡£

**åˆ›å»ºæ—¥æœŸ**: 2025-01-28
**æ›´æ–°æ—¥æœŸ**: 2025-02-03
**ç‰ˆæœ¬**: v0.3.5 (Phase 3.5)
**çŠ¶æ€**: Phase 3.5 Completed

---

## ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
3. [å·²å®ŒæˆåŠŸèƒ½ (Phase 1)](#3-å·²å®ŒæˆåŠŸèƒ½-phase-1)
4. [å·²å®ŒæˆåŠŸèƒ½ (Phase 2)](#4-å·²å®ŒæˆåŠŸèƒ½-phase-2)
5. [å·²å®ŒæˆåŠŸèƒ½ (Phase 3)](#5-å·²å®ŒæˆåŠŸèƒ½-phase-3)
6. [å·²å®ŒæˆåŠŸèƒ½ (Phase 3.5)](#6-å·²å®ŒæˆåŠŸèƒ½-phase-35)
7. [å¾…å®ç°åŠŸèƒ½ (Phase 4)](#7-å¾…å®ç°åŠŸèƒ½-phase-4)
8. [ä½¿ç”¨æ–¹å¼](#8-ä½¿ç”¨æ–¹å¼)
9. [API å‚è€ƒ](#9-api-å‚è€ƒ)
10. [å®ç°ç»†èŠ‚](#10-å®ç°ç»†èŠ‚)
11. [æµ‹è¯•ä¸éªŒè¯](#11-æµ‹è¯•ä¸éªŒè¯)
12. [é™„å½•](#é™„å½•)

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯

ç°æœ‰ä»¿çœŸå™¨é‡‡ç”¨"é¡ºåºæ—¶é—´æ¨è¿›"æ¨¡å¼ï¼Œå­˜åœ¨ä»¥ä¸‹å±€é™ï¼š

| å±€é™ | å…·ä½“è¡¨ç° | å½±å“ |
|------|----------|------|
| åŒæ­¥æ¨è¿› | æ‰€æœ‰èŠ¯ç‰‡æŒ‰ç›¸åŒæ­¥è°ƒæ¨è¿›æ—¶é—´ | æ— æ³•ç²¾ç¡®æ¨¡æ‹Ÿå¼‚æ­¥æ‰§è¡Œ |
| é‡å ç®€åŒ– | è®¡ç®—-é€šä¿¡é‡å ç”¨ç®€å•å…¬å¼ä¼°ç®— | é‡å æ”¶ç›Šä¼°è®¡ä¸å‡† |
| PP æ°”æ³¡ç²—ç³™ | æ°”æ³¡æ—¶é—´åŸºäºä¸Šä¸€ stage å®Œæˆæ—¶é—´ | å¾®æ‰¹æ¬¡è°ƒåº¦æ— æ³•å»ºæ¨¡ |
| ä¾èµ–éšå¼ | ç®—å­é—´ä¾èµ–é€šè¿‡æ‰§è¡Œé¡ºåºéšå¼è¡¨è¾¾ | éš¾ä»¥æ”¯æŒå¤æ‚è°ƒåº¦ç­–ç•¥ |

### 1.2 è®¾è®¡ç›®æ ‡

äº‹ä»¶é©±åŠ¨ä»¿çœŸå™¨çš„æ ¸å¿ƒç›®æ ‡ï¼š

1. **å¤šèŠ¯ç‰‡ç‹¬ç«‹æ¨è¿›** - æ¯ä¸ªèŠ¯ç‰‡æœ‰ç‹¬ç«‹çš„æ—¶é—´çº¿
2. **ç²¾ç¡®é‡å å»ºæ¨¡** - è®¡ç®—å’Œé€šä¿¡å¯ä»¥çœŸæ­£å¹¶è¡Œ
3. **æµæ°´çº¿ç­–ç•¥æ”¯æŒ** - GPipe / 1F1B ç­‰è°ƒåº¦ç­–ç•¥
4. **ç²¾ç¡®æ°”æ³¡è®¡ç®—** - åŸºäºèµ„æºç«äº‰çš„çœŸå®ç­‰å¾…æ—¶é—´

### 1.3 è®¾è®¡å‚è€ƒ

å€Ÿé‰´äº†ä»¥ä¸‹æˆç†Ÿå·¥å…·çš„è®¾è®¡ç†å¿µï¼š

- **[Vidur](https://github.com/microsoft/vidur)** (Microsoft, MLSys 2024) - äº‹ä»¶é©±åŠ¨æ¶æ„ã€ä¸‰å±‚è°ƒåº¦å™¨
- **[ASTRA-sim](https://github.com/astra-sim/astra-sim)** (Georgia Tech + Meta) - åˆ†å±‚æŠ½è±¡ã€é€šä¿¡å»ºæ¨¡
- **[SimPy](https://simpy.readthedocs.io/)** - Python ç¦»æ•£äº‹ä»¶ä»¿çœŸæ¡†æ¶

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EventDrivenSimulator (Phase 3)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ EventQueue  â”‚  â”‚  Resource   â”‚  â”‚ Dependency  â”‚  â”‚  Switch    â”‚ â”‚
â”‚  â”‚ (ä¼˜å…ˆé˜Ÿåˆ—)  â”‚â—€â–¶â”‚  Manager    â”‚â—€â–¶â”‚   Graph     â”‚  â”‚  Manager   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                â”‚                 â”‚               â”‚         â”‚
â”‚         â”‚                â”‚  ç®¡ç†ç«¯å£èµ„æº   â”‚               â”‚         â”‚
â”‚         â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                                 â”‚                         â”‚
â”‚         â–¼                                 â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                   Event Handlers (Phase 3)               â”‚       â”‚
â”‚  â”‚  ComputeStart â†’ ComputeEnd â†’ CommStart â†’ CommEnd        â”‚       â”‚
â”‚  â”‚  PacketSend â†’ SwitchForward â†’ PacketReceive  (NEW)      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                          â”‚                                          â”‚
â”‚                          â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              å¤ç”¨ç°æœ‰ç»„ä»¶                                 â”‚       â”‚
â”‚  â”‚  â€¢ GEMMEvaluator  â€¢ FA2Evaluator  â€¢ AllReduceEval       â”‚       â”‚
â”‚  â”‚  â€¢ GanttChartBuilder  â€¢ TopologyParser                  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—ç»“æ„

```
backend/llm_simulator/event_driven/
â”œâ”€â”€ __init__.py           # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ event.py              # äº‹ä»¶å®šä¹‰ï¼ˆ7ç§äº‹ä»¶ç±»å‹ï¼‰
â”œâ”€â”€ event_queue.py        # ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆåŸºäºheapqï¼‰
â”œâ”€â”€ resource.py           # èµ„æºç®¡ç†å™¨
â”œâ”€â”€ dependency.py         # ä¾èµ–å›¾
â””â”€â”€ simulator.py          # äº‹ä»¶é©±åŠ¨ä»¿çœŸå™¨ä¸»ç±»
```

### 2.3 äº‹ä»¶é©±åŠ¨ä¸»å¾ªç¯

```python
def _run_event_loop(self, context):
    while self.event_queue and self.events_processed < max_events:
        # 1. å–å‡ºæœ€æ—©çš„äº‹ä»¶
        event = self.event_queue.pop()

        # 2. æ¨è¿›ä»¿çœŸæ—¶é—´
        self.current_time = event.timestamp

        # 3. å¤„ç†äº‹ä»¶ï¼Œäº§ç”Ÿæ–°äº‹ä»¶
        new_events = event.handle(
            self.resource_manager,
            self.gantt_builder,
            context,
        )

        # 4. æ·»åŠ æ–°äº‹ä»¶åˆ°é˜Ÿåˆ—
        self.event_queue.push_many(new_events)

        self.events_processed += 1
```

---

## 3. å·²å®ŒæˆåŠŸèƒ½ (Phase 1)

### 3.1 äº‹ä»¶ç³»ç»Ÿ

#### äº‹ä»¶ç±»å‹æšä¸¾

```python
class EventType(IntEnum):
    # ç»“æŸäº‹ä»¶ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾ï¼‰
    COMPUTE_END = 1
    COMM_END = 2
    MEMORY_END = 3

    # å®Œæˆäº‹ä»¶ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
    LAYER_COMPLETE = 10
    STAGE_READY = 11
    BATCH_COMPLETE = 12

    # å¼€å§‹äº‹ä»¶ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
    COMPUTE_START = 20
    COMM_START = 21
    MEMORY_START = 22

    # è°ƒåº¦äº‹ä»¶ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
    SCHEDULE = 30
```

#### äº‹ä»¶æ’åºè§„åˆ™

äº‹ä»¶æŒ‰ç…§ `(timestamp, event_type, event_id)` æ’åºï¼š

1. é¦–å…ˆæŒ‰æ—¶é—´æˆ³å‡åº
2. ç›¸åŒæ—¶é—´æŒ‰äº‹ä»¶ç±»å‹ï¼ˆEND ä¼˜å…ˆäº STARTï¼‰
3. ä»ç›¸åŒæŒ‰äº‹ä»¶ IDï¼ˆä¿è¯ç¡®å®šæ€§ï¼‰

#### å·²å®ç°çš„äº‹ä»¶ç±»

| äº‹ä»¶ç±» | åŠŸèƒ½ |
|--------|------|
| `ComputeStartEvent` | è®¡ç®—å¼€å§‹ï¼Œè¯·æ±‚è®¡ç®—èµ„æºï¼Œè®°å½•åˆ° Gantt |
| `ComputeEndEvent` | è®¡ç®—ç»“æŸï¼Œè§¦å‘åç»­ä¾èµ– |
| `CommStartEvent` | é€šä¿¡å¼€å§‹ï¼Œå¤„ç†é›†åˆé€šä¿¡åŒæ­¥ |
| `CommEndEvent` | é€šä¿¡ç»“æŸï¼Œæ¸…é™¤åŒæ­¥çŠ¶æ€ |
| `LayerCompleteEvent` | å±‚å®Œæˆï¼Œè§¦å‘ PP é€šä¿¡æˆ– batch å®Œæˆ |
| `StageReadyEvent` | PP Stage å°±ç»ªï¼Œè§¦å‘ä¸‹ä¸€é˜¶æ®µ |
| `BatchCompleteEvent` | Batch å®Œæˆï¼Œè®°å½•å®Œæˆæ—¶é—´ |

### 3.2 äº‹ä»¶é˜Ÿåˆ—

åŸºäº Python `heapq` å®ç°çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼š

```python
class EventQueue:
    def push(self, event: BaseEvent) -> None: ...      # O(log n)
    def pop(self) -> BaseEvent: ...                    # O(log n)
    def peek(self) -> Optional[BaseEvent]: ...         # O(1)
    def push_many(self, events: list[BaseEvent]): ...
    def is_empty(self) -> bool: ...
    def stats(self) -> dict: ...
```

### 3.3 èµ„æºç®¡ç†å™¨

ç®¡ç†æ¯ä¸ªèŠ¯ç‰‡çš„è®¡ç®—å’Œç½‘ç»œèµ„æºï¼š

```python
class ResourceManager:
    def __init__(self, chip_ids: list[str]): ...

    # èµ„æºè¯·æ±‚
    def request_resource(
        self,
        chip_id: str,
        resource_type: ResourceType,
        requested_start: float,
        duration: float,
    ) -> tuple[float, float]: ...  # (actual_start, actual_end)

    # æ°”æ³¡è®°å½•
    def record_bubble(self, chip_id, start, duration, reason): ...
    def get_total_bubble_time(self, chip_id=None) -> float: ...
    def get_bubble_breakdown(self) -> dict[str, float]: ...

    # é›†åˆé€šä¿¡åŒæ­¥
    def record_comm_arrival(self, chip_id, comm_type, layer_index, micro_batch, arrival_time): ...
    def all_chips_ready_for_comm(self, participating_chips, comm_type, layer_index, micro_batch) -> bool: ...
```

**èµ„æºç±»å‹**ï¼š

| ç±»å‹ | è¯´æ˜ |
|------|------|
| `COMPUTE` | è®¡ç®—èµ„æºï¼ˆTensor Coreï¼‰ |
| `NETWORK` | ç½‘ç»œèµ„æºï¼ˆNVLink/IBï¼‰ |
| `MEMORY_BUS` | å†…å­˜æ€»çº¿ |

### 3.4 ä¾èµ–å›¾

ç®¡ç†ç®—å­ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼š

```python
class DependencyGraph:
    def add_node(self, node: OperatorNode): ...
    def add_edge(self, source_key, target_key, dep_type): ...
    def mark_completed(self, key): ...
    def get_ready_successors(self, key) -> list[OperatorNode]: ...
    def is_layer_complete(self, layer_index, micro_batch) -> bool: ...
```

**ä¾èµ–ç±»å‹**ï¼š

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `DATA` | æ•°æ®ä¾èµ– | GEMM éœ€è¦ç­‰ RMSNorm å®Œæˆ |
| `RESOURCE` | èµ„æºä¾èµ– | ä¸‹ä¸€ä¸ª GEMM éœ€è¦ç­‰å½“å‰å®Œæˆ |
| `SYNC` | åŒæ­¥ä¾èµ– | AllReduce éœ€è¦ç­‰æ‰€æœ‰èŠ¯ç‰‡åˆ°è¾¾ |
| `COMM` | é€šä¿¡ä¾èµ– | PP Stage 1 ç­‰ Stage 0 å‘é€ |

### 3.5 ä»¿çœŸå™¨ä¸»ç±»

```python
class EventDrivenSimulator:
    def __init__(
        self,
        topology_dict: dict,
        model: LLMModelConfig,
        inference: InferenceConfig,
        parallelism: ParallelismStrategy,
        hardware: HardwareConfig,
        config: EventDrivenSimConfig = None,
        progress_callback: Callable = None,
    ): ...

    def simulate(self) -> SimulationResult: ...
```

### 3.6 å¤ç”¨ç°æœ‰ç»„ä»¶

| ç»„ä»¶ | å¤ç”¨æ–¹å¼ |
|------|----------|
| `GEMMEvaluator` | ç›´æ¥ä½¿ç”¨ï¼Œè·å–ç®—å­å»¶è¿Ÿ |
| `FA2Evaluator` | ç›´æ¥ä½¿ç”¨ |
| `AllReduceEval` ç­‰ | ç›´æ¥ä½¿ç”¨é€šä¿¡è¯„ä¼°å™¨ |
| `GanttChartBuilder` | ç›´æ¥ä½¿ç”¨ï¼Œæ”¶é›†ä»»åŠ¡ |
| `TopologyParser` | ç›´æ¥ä½¿ç”¨ï¼Œè§£ææ‹“æ‰‘å’Œå¹¶è¡Œç»„ |
| å±‚å®šä¹‰ | ä½¿ç”¨ MHALayerã€MLPLayer ç­‰æ„å»ºä¾èµ–å›¾ |

### 3.7 æµ‹è¯•éªŒè¯

```python
# äº‹ä»¶é˜Ÿåˆ—æµ‹è¯•
queue = EventQueue()
e1 = ComputeStartEvent(timestamp=10.0, chip_id='chip_0')
e2 = ComputeStartEvent(timestamp=5.0, chip_id='chip_1')
queue.push(e1)
queue.push(e2)
assert queue.peek().timestamp == 5.0  # âœ… æ—¶é—´æ’åºæ­£ç¡®

# èµ„æºç®¡ç†æµ‹è¯•
rm = ResourceManager(['chip_0'])
start1, end1 = rm.request_resource('chip_0', ResourceType.COMPUTE, 0.0, 10.0)
start2, end2 = rm.request_resource('chip_0', ResourceType.COMPUTE, 5.0, 10.0)
assert start2 == 10.0  # âœ… èµ„æºç«äº‰æ­£ç¡®å¤„ç†

# ä¾èµ–å›¾æµ‹è¯•
graph = DependencyGraph()
graph.add_node(OperatorNode(name='op1', ...))
graph.add_node(OperatorNode(name='op2', ...))
graph.add_edge(op1.key, op2.key)
assert graph.get_stats()['total_edges'] == 1  # âœ… ä¾èµ–å…³ç³»æ­£ç¡®
```

---

## 4. å·²å®ŒæˆåŠŸèƒ½ (Phase 2)

### 4.1 API é›†æˆ

äº‹ä»¶é©±åŠ¨ä»¿çœŸå™¨ç°å·²å®Œå…¨é›†æˆåˆ°åç«¯ APIï¼Œå¯é€šè¿‡ `/api/simulate` ç«¯ç‚¹è°ƒç”¨ã€‚

#### è¯·æ±‚æ ¼å¼

```json
POST /api/simulate
{
    "topology": { ... },
    "model": { ... },
    "inference": { ... },
    "parallelism": { ... },
    "hardware": { ... },
    "use_event_driven": true,
    "event_driven_config": {
        "max_simulated_tokens": 16,
        "enable_comm_overlap": true,
        "overlap_ratio": 0.8,
        "enable_chunked_comm": true,
        "comm_chunk_size_mb": 16.0,
        "enable_tbo": true,
        "pp_schedule": "gpipe"
    }
}
```

#### å…³é”®å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `use_event_driven` | bool | false | æ˜¯å¦ä½¿ç”¨äº‹ä»¶é©±åŠ¨ä»¿çœŸ |
| `enable_comm_overlap` | bool | true | æ˜¯å¦å¯ç”¨è®¡ç®—-é€šä¿¡é‡å  |
| `overlap_ratio` | float | 0.8 | é‡å æ¯”ä¾‹ï¼ˆ0-1ï¼‰ |
| `enable_chunked_comm` | bool | false | æ˜¯å¦å¯ç”¨åˆ†å—ä¼ è¾“ |
| `comm_chunk_size_mb` | float | 16.0 | æ¯å—å¤§å°ï¼ˆMBï¼‰ |
| `enable_tbo` | bool | true | æ˜¯å¦å¯ç”¨ MoE TBO ä¼˜åŒ– |

### 4.2 è®¡ç®—-é€šä¿¡å¹¶è¡Œè°ƒåº¦

å®ç°äº†çœŸæ­£çš„è®¡ç®—-é€šä¿¡å¹¶è¡Œæ‰§è¡Œï¼Œåˆ©ç”¨ç‹¬ç«‹çš„èµ„æºè¿½è¸ªå®ç°ç²¾ç¡®çš„é‡å å»ºæ¨¡ã€‚

#### æ ¸å¿ƒæœºåˆ¶

```
ä¼ ç»Ÿé¡ºåºæ‰§è¡Œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Compute Op     â”‚â”‚  TP AllReduce    â”‚â”‚   Next Compute   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        10us              8us                  10us
                                          Total: 28us

é‡å æ‰§è¡Œ (overlap_ratio=0.8):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Compute Op     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ åœ¨å®Œæˆ 20% æ—¶å¯åŠ¨é€šä¿¡
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   TP AllReduce     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ é€šä¿¡å®Œæˆ
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Next Compute   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          Total: ~22us (èŠ‚çœ ~20%)
```

#### äº‹ä»¶å¤„ç†æµç¨‹

```python
# ComputeStartEvent.handle() ä¸­çš„é‡å è°ƒåº¦é€»è¾‘

def handle(self, resource_manager, gantt_builder, context):
    # 1. è¯·æ±‚è®¡ç®—èµ„æº
    actual_start, actual_end = resource_manager.request_resource(
        chip_id, ResourceType.COMPUTE, timestamp, duration
    )

    # 2. æ£€æŸ¥æ˜¯å¦å¯ç”¨é‡å ä¸”åç»­æœ‰é€šä¿¡
    if context["enable_comm_overlap"] and self.has_following_comm:
        # è®¡ç®—æå‰å¯åŠ¨é€šä¿¡çš„æ—¶é—´ç‚¹
        overlap_start = actual_start + duration * (1 - context["overlap_ratio"])

        # æ£€æŸ¥ç½‘ç»œèµ„æºæ˜¯å¦å¯ç”¨
        network_idle = resource_manager.get_resource_idle_time(
            chip_id, ResourceType.NETWORK
        )

        # åˆ›å»ºæå‰çš„é€šä¿¡äº‹ä»¶
        comm_start_time = max(overlap_start, network_idle)
        new_events.append(CommStartEvent(
            timestamp=comm_start_time,
            is_overlapped=True,  # æ ‡è®°ä¸ºé‡å è°ƒåº¦
            ...
        ))

    # 3. åˆ›å»ºè®¡ç®—ç»“æŸäº‹ä»¶
    new_events.append(ComputeEndEvent(
        has_overlapped_comm=True,  # é¿å…é‡å¤è§¦å‘
        ...
    ))
```

### 4.3 åˆ†å—ä¼ è¾“ (Chunked Communication)

å°†å¤§å‹ AllReduce åˆ†æˆå¤šä¸ªå—ï¼Œå®ç°æ›´ç»†ç²’åº¦çš„æµæ°´çº¿ã€‚

#### å·¥ä½œåŸç†

```
ä¼ ç»Ÿ AllReduce (256MB):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AllReduce 256MB              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      å®Œæˆåæ‰èƒ½å¼€å§‹ä¸‹ä¸€ä¸ªè®¡ç®—

åˆ†å— AllReduce (16MB Ã— 16 chunks):
â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”...â”Œâ”€â”€â”€â”€â”
â”‚ C0 â”‚â”‚ C1 â”‚â”‚ C2 â”‚â”‚ C3 â”‚   â”‚C15 â”‚
â””â”€â”€â”¬â”€â”˜â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”˜
   â”‚
   â”‚ ç¬¬ä¸€å—å®Œæˆå³å¯å¼€å§‹ä¸‹ä¸€ä¸ªè®¡ç®—
   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚        Next Compute (æµæ°´çº¿)      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ–°å¢äº‹ä»¶ç±»å‹

```python
@dataclass
class ChunkedCommStartEvent(BaseEvent):
    """åˆ†å—é€šä¿¡å¼€å§‹äº‹ä»¶"""
    chunk_index: int = 0           # å½“å‰å—ç´¢å¼•
    total_chunks: int = 1          # æ€»å—æ•°
    chunk_size_bytes: float = 0.0  # æ¯å—å¤§å°
    duration_per_chunk_us: float   # æ¯å—ä¼ è¾“æ—¶é—´
    following_compute_op: Any      # åç»­è®¡ç®—ç®—å­ï¼ˆä»…ç¬¬ä¸€å—ï¼‰

@dataclass
class ChunkedCommEndEvent(BaseEvent):
    """åˆ†å—é€šä¿¡ç»“æŸäº‹ä»¶"""
    chunk_index: int
    total_chunks: int

    def handle(self, ...):
        # ç¬¬ä¸€å—å®Œæˆæ—¶ï¼Œè§¦å‘åç»­è®¡ç®—
        if self.chunk_index == 0 and self.following_compute_op:
            new_events.append(ComputeStartEvent(...))

        # æœ€åä¸€å—å®Œæˆæ—¶ï¼Œæ ‡è®°æ•´ä¸ªé€šä¿¡å®Œæˆ
        if self.chunk_index == self.total_chunks - 1:
            dependency_graph.mark_completed(...)
```

#### å¯ç”¨æ¡ä»¶

åˆ†å—ä¼ è¾“ä»…åœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹å¯ç”¨ï¼š
- `enable_chunked_comm = true`
- é€šä¿¡ç±»å‹ä¸º `allreduce`ã€`allgather` æˆ– `reduce_scatter`
- é€šä¿¡å¤§å° > 2 Ã— `comm_chunk_size_mb`

### 4.4 MoE TBO ä¼˜åŒ– (Tensor-Bus Overlap)

MoE å±‚çš„ Dispatch é€šä¿¡å’Œ Expert è®¡ç®—å¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚

#### MoE å±‚ç»“æ„

```
æ ‡å‡† MoE å±‚æ‰§è¡Œé¡ºåº:
Gate â†’ Dispatch â†’ Expert â†’ Combine

ä¼ ç»Ÿé¡ºåºæ‰§è¡Œ:
â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gate â”‚â”‚ Dispatch â”‚â”‚      Expert        â”‚â”‚ Combine  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          Total: 40us

TBO ä¼˜åŒ–å (Dispatch å’Œ Expert å¹¶è¡Œ):
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Gate â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                      â”‚
   â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dispatch â”‚    â”‚      Expert        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ ç­‰å¾…ä¸¤è€…éƒ½å®Œæˆ
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Combine  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    Total: ~30us (èŠ‚çœ ~25%)
```

#### ä¾èµ–å›¾æ„å»º

```python
def build_moe_layer_with_tbo(self, layer_idx, layer, enable_tbo=True):
    """æ„å»º MoE å±‚çš„ä¾èµ–å›¾ï¼ˆæ”¯æŒ TBO ä¼˜åŒ–ï¼‰"""

    if enable_tbo:
        # TBO æ¨¡å¼ï¼šå…è®¸å¹¶è¡Œ

        # Gate â†’ Dispatchï¼ˆé¡ºåºï¼‰
        add_edge(gate.key, dispatch.key, DATA)

        # Gate â†’ Expertï¼ˆå¹¶è¡Œåˆ†æ”¯ï¼Œè€Œé Dispatch â†’ Expertï¼‰
        add_edge(gate.key, expert.key, DATA)

        # Combine éœ€è¦ç­‰å¾… Expert å’Œ Dispatch éƒ½å®Œæˆ
        add_edge(expert.key, combine.key, DATA)
        add_edge(dispatch.key, combine.key, SYNC)
    else:
        # é TBO æ¨¡å¼ï¼šä¸¥æ ¼é¡ºåº
        for i in range(1, len(all_ops)):
            add_edge(all_ops[i-1].key, all_ops[i].key, DATA)
```

### 4.5 ä»¿çœŸæµç¨‹æ›´æ–°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EventDrivenSimulator.simulate()                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. åˆå§‹åŒ–                                                           â”‚
â”‚     â””â”€â”€ reset_event_counter(), event_queue.clear(), etc.           â”‚
â”‚                                                                      â”‚
â”‚  2. æ„å»ºä¾èµ–å›¾ (æ”¯æŒ MoE TBO)                                         â”‚
â”‚     â””â”€â”€ è¯†åˆ« MoE å±‚ â†’ build_moe_layer_with_tbo()                    â”‚
â”‚     â””â”€â”€ Dense å±‚ â†’ æ ‡å‡†ä¾èµ–æ„å»º                                      â”‚
â”‚                                                                      â”‚
â”‚  3. åˆ›å»ºä»¿çœŸä¸Šä¸‹æ–‡ (åŒ…å«é‡å é…ç½®)                                       â”‚
â”‚     â””â”€â”€ enable_comm_overlap, overlap_ratio, enable_chunked_comm     â”‚
â”‚                                                                      â”‚
â”‚  4. äº‹ä»¶å¾ªç¯                                                          â”‚
â”‚     â””â”€â”€ ComputeStartEvent: æ£€æŸ¥åç»­é€šä¿¡ â†’ æå‰è°ƒåº¦                    â”‚
â”‚     â””â”€â”€ CommStartEvent: æ£€æŸ¥æ˜¯å¦åˆ†å— â†’ åˆ›å»º ChunkedCommStartEvent    â”‚
â”‚     â””â”€â”€ ChunkedCommEndEvent: ç¬¬ä¸€å—å®Œæˆ â†’ è§¦å‘ä¸‹ä¸€ä¸ªè®¡ç®—              â”‚
â”‚                                                                      â”‚
â”‚  5. æ”¶é›†ç»“æœ                                                          â”‚
â”‚     â””â”€â”€ ç»Ÿè®¡é‡å æ—¶é—´ã€æ°”æ³¡æ—¶é—´ã€MFU ç­‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å·²å®ŒæˆåŠŸèƒ½ (Phase 3)

**ç›®æ ‡**: Switch èŠ‚ç‚¹å»ºæ¨¡åŸºç¡€å®ç°ï¼ˆæ˜¾å¼ Switch + åŒ…çº§äº‹ä»¶ + å¤šè·³è·¯ç”±ï¼‰

**å®Œæˆæ—¶é—´**: 2025-02-03

### 5.1 æ ¸å¿ƒåŠŸèƒ½

#### 1. Switch æ‹“æ‰‘æ„å»º

**æ–°å¢æ•°æ®ç»“æ„**:
- `SwitchHardwareConfig`: Switch ç¡¬ä»¶é…ç½®ï¼ˆç«¯å£æ•°ã€å¸¦å®½ã€å»¶è¿Ÿï¼‰
- `SwitchInstanceConfig`: Switch å®ä¾‹é…ç½®ï¼ˆæ‹“æ‰‘ä½ç½®ã€ç«¯å£æ˜ å°„ï¼‰
- `SwitchNode`: Switch è¿è¡Œæ—¶çŠ¶æ€ï¼ˆç«¯å£çŠ¶æ€ã€è·¯ç”±ç¼“å­˜ï¼‰
- `SwitchGraph`: Switch æ‹“æ‰‘å›¾ï¼ˆSwitch å®ä¾‹ã€ç¡¬ä»¶é…ç½®ã€è¿æ¥å…³ç³»ï¼‰

**é»˜è®¤ Switch é…ç½®**:
| ç±»å‹ | ç«¯å£æ•° | å¸¦å®½ | å¤„ç†å»¶è¿Ÿ | ç¼“å†²åŒº |
|------|--------|------|----------|--------|
| Leaf 72 | 72 | 100 Gbps | 0.5 us | 32 MB |
| Leaf 128 | 128 | 400 Gbps | 0.3 us | 64 MB |
| Spine 512 | 512 | 400 Gbps | 0.8 us | 128 MB |
| Core 1024 | 1024 | 400 Gbps | 1.0 us | 256 MB |

#### 2. è·¯ç”±è®¡ç®—

**SwitchManager** ç±»æä¾›è·¯ç”±æœåŠ¡ï¼š
- `compute_route(src_chip, dst_chip)`: è®¡ç®—é€šä¿¡è·¯å¾„
- **è·¯ç”±ç­–ç•¥**: åŸºäºæ‹“æ‰‘å±‚çº§ï¼ˆåŒ Board: æ—  Switch â†’ åŒ Rack: Leaf â†’ è·¨ Rack: Leafâ†’Spineâ†’Leafï¼‰
- **è·¯ç”±ç¼“å­˜**: ç¼“å­˜å·²è®¡ç®—çš„è·¯å¾„ï¼Œé¿å…é‡å¤è®¡ç®—

**ç¤ºä¾‹è·¯å¾„**:
```
Chip_A (Rack 0, Board 0) â†’ Chip_B (Rack 1, Board 0)
è·¯å¾„: ["leaf_0", "spine_0", "leaf_1"]
```

#### 3. åŒ…çº§äº‹ä»¶æ¨¡å‹

**ä»æµçº§æ”¹ä¸ºåŒ…çº§ä»¿çœŸ**:
- **æ—§æ¨¡å‹**: `CommStartEvent` â†’ `CommEndEvent`ï¼ˆ1 æ¬¡é€šä¿¡ = 1 ä¸ªäº‹ä»¶ï¼‰
- **æ–°æ¨¡å‹**: `CommStartEvent` â†’ N Ã— `PacketSendEvent` â†’ N Ã— `SwitchForwardEvent` â†’ N Ã— `PacketReceiveEvent`

**æ–°å¢äº‹ä»¶ç±»å‹**:
- `PacketSendEvent` (EventType.PACKET_SEND): èŠ¯ç‰‡ NIC å‘é€æ•°æ®åŒ…
- `SwitchForwardEvent` (EventType.SWITCH_FORWARD): Switch è½¬å‘æ•°æ®åŒ…
- `PacketReceiveEvent` (EventType.PACKET_RECEIVE): æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡èŠ¯ç‰‡

**åŒ…å¤§å°é…ç½®**:
- é»˜è®¤: 512 KBï¼ˆNCCL Chunk çº§åˆ«ï¼‰
- å¯é…ç½®: 128 KB - 4 MBï¼ˆå¹³è¡¡ç²¾åº¦å’Œæ€§èƒ½ï¼‰

#### 4. å¤šè·³è·¯ç”±ä¸ç«¯å£èµ„æº

**Switch ç«¯å£èµ„æºç®¡ç†**:
- æ–°å¢èµ„æºç±»å‹: `ResourceType.SWITCH_PORT`
- ç«¯å£æ ‡è¯†: `"switch_id:port_number"`
- æ’é˜Ÿæœºåˆ¶: é€šè¿‡ `idle_at` è‡ªç„¶å®ç°ï¼ˆååˆ°çš„åŒ…ç­‰å¾…ï¼‰

**å¤šè·³è½¬å‘æµç¨‹**:
```
1. PacketSendEvent: NIC ä¸²è¡ŒåŒ– â†’ ç”Ÿæˆ PacketInFlightEvent
2. PacketInFlightEvent: çº¿ç¼†ä¼ æ’­ â†’ åˆ°è¾¾ Switch
3. SwitchForwardEvent (Hop 1): Leaf å¤„ç†+è½¬å‘ â†’ åˆ°è¾¾ Spine
4. SwitchForwardEvent (Hop 2): Spine å¤„ç†+è½¬å‘ â†’ åˆ°è¾¾ Leaf
5. SwitchForwardEvent (Hop 3): Leaf å¤„ç†+è½¬å‘ â†’ åˆ°è¾¾ç›®æ ‡
6. PacketReceiveEvent: ç›®æ ‡æ¥æ”¶ â†’ å¦‚æœæ˜¯æœ€åä¸€ä¸ªåŒ…ï¼Œè§¦å‘ CommEndEvent
```

**å»¶è¿Ÿç»„æˆ**:
- NIC ä¸²è¡ŒåŒ–: `packet_size / bandwidth`
- Switch å¤„ç†: `processing_delay_us`ï¼ˆ0.3-1.0 usï¼‰
- Switch è½¬å‘: `packet_size / port_bandwidth`
- çº¿ç¼†ä¼ æ’­: `distance / speed_of_light`ï¼ˆé€šå¸¸å¿½ç•¥ï¼‰

### 5.2 å…³é”®ä»£ç 

| æ–‡ä»¶ | æ–°å¢å†…å®¹ | ä»£ç é‡ |
|------|---------|--------|
| `event_driven/switch_manager.py` | `SwitchManager` ç±» + è·¯ç”±ç®—æ³• | ~550 è¡Œ |
| `config/types.py` | Switch æ•°æ®ç±»å‹å®šä¹‰ | ~220 è¡Œ |
| `event_driven/event.py` | åŒ…çº§äº‹ä»¶ç±»ï¼ˆPacketSend, SwitchForward, PacketReceiveï¼‰ | ~450 è¡Œ |
| `event_driven/resource.py` | Switch ç«¯å£èµ„æºç®¡ç† | ~160 è¡Œ |
| `core/topology.py` | Switch é…ç½®è§£æ | +130 è¡Œ |

**æ€»è®¡**: ~1,510 è¡Œæ–°å¢ä»£ç 

### 5.3 æ€§èƒ½å½±å“

**äº‹ä»¶æ•°é‡å¢åŠ **:
- æµçº§æ¨¡å‹: 1 æ¬¡é€šä¿¡ = ~10 ä¸ªäº‹ä»¶
- åŒ…çº§æ¨¡å‹: 1 æ¬¡é€šä¿¡ = 512 ä¸ªåŒ… Ã— 11 ä¸ªäº‹ä»¶/åŒ… = ~5,632 ä¸ªäº‹ä»¶
- **å¢é•¿**: ~560x

**ç²¾åº¦æå‡**:
- ç²¾ç¡®å»ºæ¨¡å¤šè·³å»¶è¿Ÿï¼ˆChip â†’ Leaf â†’ Spine â†’ Leaf â†’ Chipï¼‰
- ç«¯å£ç«äº‰è‡ªåŠ¨æ’é˜Ÿï¼ˆé€šè¿‡ `idle_at` æœºåˆ¶ï¼‰
- æ”¯æŒå¼‚æ„ Switch ç±»å‹

**æ€§èƒ½ä¼˜åŒ–**:
- è·¯ç”±è¡¨ç¼“å­˜ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
- é“¾å¼åŒ…ç”Ÿæˆï¼ˆé¿å…ä¸€æ¬¡æ€§åˆ›å»º 512 ä¸ªåŒ…ï¼‰
- å¯é…ç½®åŒ…å¤§å°ï¼ˆ1 MB æ—¶é™è‡³ 256 ä¸ªåŒ…ï¼‰

### 5.4 å®æ–½çŠ¶æ€

âœ… **å·²å®Œæˆ**:
- [x] Switch æ‹“æ‰‘æ•°æ®ç»“æ„
- [x] Switch é…ç½®è§£æï¼ˆä»å‰ç«¯æ‹“æ‰‘ï¼‰
- [x] è·¯ç”±è®¡ç®—ç®—æ³•
- [x] åŒ…çº§äº‹ä»¶ç±»å‹
- [x] å¤šè·³è½¬å‘é€»è¾‘
- [x] ç«¯å£èµ„æºç®¡ç†
- [x] åŸºç¡€æµ‹è¯•éªŒè¯

â³ **å¾…å¢å¼º**ï¼ˆPhase 3.5ï¼‰:
- [ ] è½¬å‘æ¨¡å¼æ”¯æŒï¼ˆStore-and-Forward vs Cut-Throughï¼‰
- [ ] Round-Robin è°ƒåº¦ç®—æ³•
- [ ] ç«¯å£é˜Ÿåˆ—ç®¡ç†

---

## 6. å·²å®ŒæˆåŠŸèƒ½ (Phase 3.5)

**ç›®æ ‡**: Switch è°ƒåº¦ç­–ç•¥å®ç°ï¼ˆè½¬å‘æ¨¡å¼ + Round-Robin è°ƒåº¦ï¼‰

**å®Œæˆæ—¶é—´**: 2025-02-03

### 6.1 æ ¸å¿ƒåŠŸèƒ½

#### 1. è½¬å‘æ¨¡å¼æ”¯æŒ

å®ç°ä¸¤ç§ä¸»æµäº¤æ¢æœºè½¬å‘æ¨¡å¼ï¼š

| è½¬å‘æ¨¡å¼ | å»¶è¿Ÿè®¡ç®— | é€‚ç”¨åœºæ™¯ | å®ç°çŠ¶æ€ |
|---------|---------|---------|---------|
| **Store-and-Forward** | å¤„ç†å»¶è¿Ÿ + ä¸²è¡ŒåŒ–å»¶è¿Ÿ | ä¼ ç»Ÿäº¤æ¢æœºï¼Œéœ€è¦å®Œæ•´æ¥æ”¶åè½¬å‘ | âœ… |
| **Cut-Through** | å›ºå®šå»¶è¿Ÿï¼ˆ~0.1 usï¼‰ï¼Œå¿½ç•¥åŒ…å¤§å° | ç°ä»£é«˜æ€§èƒ½äº¤æ¢æœºï¼Œè¯»å–å¸§å¤´åç«‹å³è½¬å‘ | âœ… |

**é…ç½®æ–¹å¼**:
```yaml
# åœ¨ SwitchHardwareConfig ä¸­é…ç½®
forwarding_mode: "cut_through"  # æˆ– "store_and_forward"
cut_through_delay_us: 0.1        # Cut-Through å›ºå®šå»¶è¿Ÿ
processing_delay_us: 0.5         # Store-and-Forward å¤„ç†å»¶è¿Ÿ
```

**æ€§èƒ½å¯¹æ¯”**ï¼ˆ512 KB åŒ…ï¼Œ100 Gbps ç«¯å£ï¼‰:
- Store-and-Forward: 0.5 + 41.94 = **42.44 us**
- Cut-Through: **0.08 us**ï¼ˆ530x åŠ é€Ÿï¼‰

#### 2. Round-Robin ç«¯å£è°ƒåº¦

å®ç°å…¬å¹³çš„ç«¯å£è°ƒåº¦ç®—æ³•ï¼Œè§£å†³å¤šæµç«äº‰åŒä¸€è¾“å‡ºç«¯å£çš„é—®é¢˜ï¼š

**æ ¸å¿ƒæ•°æ®ç»“æ„**:
```python
@dataclass
class PortQueue:
    """ç«¯å£é˜Ÿåˆ—ï¼ˆç”¨äºè°ƒåº¦ï¼‰"""
    port_id: str
    switch_id: str
    output_port: int

    # ç­‰å¾…é˜Ÿåˆ—ï¼ˆæŒ‰è¾“å…¥ç«¯å£åˆ†ç»„ï¼‰
    waiting_packets: dict[str, list[SwitchForwardEvent]]

    # Round-Robin è°ƒåº¦æŒ‡é’ˆ
    rr_pointer: int = 0

    def schedule_next(self) -> Optional[SwitchForwardEvent]:
        """Round-Robin è°ƒåº¦ä¸‹ä¸€ä¸ªæ•°æ®åŒ…"""
        # æŒ‰è¾“å…¥ç«¯å£è½®è¯¢ï¼Œä¿è¯å…¬å¹³æ€§
```

**è°ƒåº¦æµç¨‹**:
```
1. æ•°æ®åŒ…åˆ°è¾¾ Switch â†’ æ£€æŸ¥è¾“å‡ºç«¯å£æ˜¯å¦ç©ºé—²
2. ç«¯å£å¿™ç¢Œ â†’ å…¥é˜Ÿç­‰å¾…ï¼ˆæŒ‰è¾“å…¥ç«¯å£åˆ†ç»„ï¼‰
3. ç«¯å£ç©ºé—² â†’ Round-Robin é€‰æ‹©ä¸‹ä¸€ä¸ªåŒ…
4. å¤„ç†å®Œæˆ â†’ è§¦å‘ PortScheduleEventï¼Œè°ƒåº¦é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªåŒ…
```

**å…¬å¹³æ€§ä¿è¯**:
- 4 ä¸ªæµï¼ˆ2 ä¸ªè¾“å…¥ç«¯å£ï¼‰åŒæ—¶åˆ°è¾¾
- è°ƒåº¦é¡ºåº: `[packet_0, packet_1, packet_2, packet_3]`ï¼ˆè½®è¯¢ï¼‰
- æ¯ä¸ªè¾“å…¥ç«¯å£è·å¾—å…¬å¹³çš„è°ƒåº¦æœºä¼š

#### 3. æ–°å¢äº‹ä»¶ç±»å‹

**PortScheduleEvent** (EventType.PORT_SCHEDULE):
- ç«¯å£è½¬å‘å®Œæˆåè§¦å‘
- ä»ç«¯å£é˜Ÿåˆ—ä¸­ Round-Robin é€‰æ‹©ä¸‹ä¸€ä¸ªåŒ…
- æ›´æ–°åŒ…çš„æ—¶é—´æˆ³ä¸ºå½“å‰æ—¶åˆ»ï¼ˆç«¯å£ç©ºé—²æ—¶åˆ»ï¼‰

**äº‹ä»¶å¤„ç†æµç¨‹**:
```
SwitchForwardEvent.handle():
  1. æ ¹æ®è½¬å‘æ¨¡å¼è®¡ç®—å»¶è¿Ÿ
  2. æ£€æŸ¥ç«¯å£æ˜¯å¦ç©ºé—²
  3. å¦‚æœå¿™ç¢Œ â†’ å…¥é˜Ÿç­‰å¾…ï¼ˆreturn []ï¼‰
  4. å¦‚æœç©ºé—² â†’ è¯·æ±‚ç«¯å£èµ„æº
  5. è½¬å‘å®Œæˆ â†’ ç”Ÿæˆ PortScheduleEvent

PortScheduleEvent.handle():
  1. ä»ç«¯å£é˜Ÿåˆ— Round-Robin é€‰æ‹©ä¸‹ä¸€ä¸ªåŒ…
  2. é‡æ–°è§¦å‘ SwitchForwardEventï¼ˆç»•è¿‡æ’é˜Ÿé€»è¾‘ï¼‰
```

### 6.2 å…³é”®ä»£ç å˜æ›´

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | ä»£ç é‡ |
|------|---------|--------|
| `event_driven/event.py` | æ–°å¢ `PORT_SCHEDULE` äº‹ä»¶ç±»å‹ + `PortScheduleEvent` ç±» | +90 è¡Œ |
| `event_driven/switch_manager.py` | æ–°å¢ `PortQueue` ç±» + `get_port_queue()` æ–¹æ³• | +110 è¡Œ |
| `event_driven/resource.py` | æ–°å¢ `get_switch_port_idle_time()` æ–¹æ³• | +20 è¡Œ |
| `event_driven/event.py` | `SwitchForwardEvent.handle()` å¢å¼ºï¼ˆè½¬å‘æ¨¡å¼ + æ’é˜Ÿé€»è¾‘ï¼‰ | +80 è¡Œä¿®æ”¹ |

**æ€»è®¡**: ~300 è¡Œæ–°å¢/ä¿®æ”¹

### 6.3 æµ‹è¯•éªŒè¯

**æµ‹è¯•å¥—ä»¶**: `backend/tests/test_switch_scheduling.py`

| æµ‹è¯•é¡¹ | éªŒè¯å†…å®¹ | çŠ¶æ€ |
|--------|---------|------|
| **PortQueue RR è°ƒåº¦** | 4 ä¸ªåŒ…å…¥é˜Ÿ â†’ Round-Robin è°ƒåº¦é¡ºåºæ­£ç¡® | âœ… PASS |
| **è½¬å‘æ¨¡å¼å»¶è¿Ÿè®¡ç®—** | Store-and-Forward vs Cut-Through å»¶è¿Ÿå¯¹æ¯” | âœ… PASS |
| **PortScheduleEvent å¤„ç†** | 3 ä¸ªåŒ…å…¥é˜Ÿ â†’ è°ƒåº¦ 1 ä¸ª â†’ å‰©ä½™ 2 ä¸ª | âœ… PASS |

**æµ‹è¯•è¾“å‡ºç¤ºä¾‹**:
```
Test 1: PortQueue Round-Robin Scheduling
[OK] Enqueued 4 packets (port_0: 2, port_1: 2)
[OK] Round-Robin scheduling order: [packet_0, packet_1, packet_2, packet_3]
[PASS] Scheduling order is correct!

Test 2: Forwarding Mode Latency Calculation
Store-and-Forward: 42.44 us
Cut-Through: 0.08 us
Speedup: 530.54x
[PASS] Cut-Through has lower latency!

Test 3: PortScheduleEvent Handling
[OK] Initial queue size: 3 packets
[OK] Scheduled 1 packet, remaining: 2 packets
[PASS] Scheduling logic is correct!
```

### 6.4 æ€§èƒ½å½±å“

**äº‹ä»¶æ•°é‡å¢åŠ **:
- æ¯ä¸ªæ•°æ®åŒ…è½¬å‘å®Œæˆåï¼Œé¢å¤–ç”Ÿæˆ 1 ä¸ª `PortScheduleEvent`
- å¯¹äº 256 MB é€šä¿¡ï¼ˆ512 ä¸ª 512 KB åŒ…ï¼‰ï¼Œå¢åŠ  512 ä¸ªè°ƒåº¦äº‹ä»¶
- æ€»äº‹ä»¶æ•°: ~5,632 â†’ ~6,144ï¼ˆå¢åŠ  9%ï¼‰

**ä»¿çœŸæ—¶é—´å½±å“**:
- ç«¯å£é˜Ÿåˆ—ç»´æŠ¤å¼€é”€: <5%
- Round-Robin è°ƒåº¦å¼€é”€: <3%
- **æ€»ä½“å½±å“**: <8%

**ç²¾åº¦æå‡**:
- ç²¾ç¡®å»ºæ¨¡ç«¯å£ç«äº‰å’Œæ’é˜Ÿå»¶è¿Ÿ
- æ”¯æŒ Cut-Through æ¨¡å¼çš„ä½å»¶è¿Ÿç‰¹æ€§
- å…¬å¹³è°ƒåº¦ç®—æ³•ç¬¦åˆçœŸå®ç¡¬ä»¶è¡Œä¸º

### 6.5 å®æ–½çŠ¶æ€

âœ… **å·²å®Œæˆ**:
- [x] `PORT_SCHEDULE` äº‹ä»¶ç±»å‹å®šä¹‰
- [x] `PortQueue` æ•°æ®ç»“æ„å’Œ Round-Robin ç®—æ³•
- [x] `PortScheduleEvent` äº‹ä»¶å¤„ç†
- [x] `SwitchForwardEvent` è½¬å‘æ¨¡å¼æ”¯æŒ
- [x] ç«¯å£æ’é˜Ÿé€»è¾‘
- [x] æµ‹è¯•éªŒè¯ï¼ˆ3 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

ğŸ”„ **å¯é€‰å¢å¼º**ï¼ˆæœªå®æ–½ï¼‰:
- [ ] Gantt å›¾æ˜¾ç¤º Switch å»¶è¿Ÿå’Œç«¯å£ç«äº‰
- [ ] æ‹“æ‰‘ YAML ä¸­é…ç½®è½¬å‘æ¨¡å¼
- [ ] ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•ï¼ˆTP=16 è·¨ Rack AllReduceï¼‰
- [ ] è¾“å…¥ç«¯å£æ£€æµ‹ï¼ˆå½“å‰ç®€åŒ–ä¸º "nic"ï¼‰

---

## 7. å¾…å®ç°åŠŸèƒ½ (Phase 4)

### 7.1 Phase 4: ç²¾ç»†åŒ–å¢å¼º

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| **Kernel Launch å¼€é”€** | P1 | æ¯ä¸ª kernel çš„å¯åŠ¨å»¶è¿Ÿ |
| **é‡åŒ–æ”¯æŒ** | P1 | INT8/FP8 é‡åŒ–å»ºæ¨¡ |
| **ç½‘ç»œæ‹¥å¡å»ºæ¨¡** | P2 | å¤šé€šä¿¡æµç«äº‰å¸¦å®½ï¼ˆå·²éƒ¨åˆ†å®Œæˆï¼‰ |
| **åŠ¨æ€ Batching** | P2 | Continuous Batching æ”¯æŒ |
| **1F1B è°ƒåº¦ç­–ç•¥** | P1 | æ›´é«˜æ•ˆçš„æµæ°´çº¿è°ƒåº¦ |

### 7.2 Phase 4: ç”Ÿäº§å°±ç»ª

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| **å®Œæ•´æµ‹è¯•è¦†ç›–** | P0 | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• |
| **æ€§èƒ½åŸºå‡†** | P0 | ä¸çœŸå®ç³»ç»Ÿå¯¹æ¯”éªŒè¯ |
| **æ–‡æ¡£å®Œå–„** | P0 | API æ–‡æ¡£ + ä½¿ç”¨æŒ‡å— |
| **å‰ç«¯é›†æˆ** | P0 | å‰ç«¯å¯é€‰æ‹©ä»¿çœŸæ¨¡å¼ |

### 7.3 å®æ–½è·¯çº¿å›¾

```
Phase 1: åŸºç¡€äº‹ä»¶ç³»ç»Ÿ âœ…           Phase 2: é«˜çº§ç‰¹æ€§ âœ…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Event & EventQueue   â”‚        â”‚ â€¢ API é›†æˆ âœ…          â”‚
â”‚ â€¢ Resource Manager     â”‚        â”‚ â€¢ è®¡ç®—-é€šä¿¡é‡å  âœ…     â”‚
â”‚ â€¢ åŸºç¡€ Handler         â”‚  â”€â”€â–¶   â”‚ â€¢ MoE TBO âœ…           â”‚
â”‚ â€¢ ä¾èµ–å›¾æ„å»º           â”‚        â”‚ â€¢ åˆ†å—ä¼ è¾“å»ºæ¨¡ âœ…      â”‚
â”‚ â€¢ ç®€å•åœºæ™¯éªŒè¯         â”‚        â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”‚                                  â”‚
         â–¼                                  â–¼
Phase 3: Switch åŸºç¡€ âœ…            Phase 3.5: Switch è°ƒåº¦ âœ…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Switch æ‹“æ‰‘æ„å»º      â”‚        â”‚ â€¢ è½¬å‘æ¨¡å¼æ”¯æŒ         â”‚
â”‚ â€¢ è·¯ç”±è®¡ç®—             â”‚  â”€â”€â–¶   â”‚ â€¢ Round-Robin è°ƒåº¦     â”‚
â”‚ â€¢ åŒ…çº§äº‹ä»¶             â”‚        â”‚ â€¢ ç«¯å£é˜Ÿåˆ—ç®¡ç†         â”‚
â”‚ â€¢ å¤šè·³è½¬å‘             â”‚        â”‚ â€¢ æ€§èƒ½æµ‹è¯•éªŒè¯         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”‚                                  â”‚
         â–¼                                  â–¼
Phase 4: ç²¾ç»†åŒ–å¢å¼º                Phase 5: ç”Ÿäº§å°±ç»ª
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Kernel Launch å¼€é”€   â”‚        â”‚ â€¢ å®Œæ•´æµ‹è¯•è¦†ç›–         â”‚
â”‚ â€¢ é‡åŒ–æ”¯æŒ             â”‚  â”€â”€â–¶   â”‚ â€¢ æ€§èƒ½åŸºå‡†             â”‚
â”‚ â€¢ Gantt ä¼˜åŒ–           â”‚        â”‚ â€¢ æ–‡æ¡£å®Œå–„             â”‚
â”‚ â€¢ 1F1B è°ƒåº¦ç­–ç•¥        â”‚        â”‚ â€¢ å‰ç«¯é›†æˆ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ä½¿ç”¨æ–¹å¼

### 8.1 é€šè¿‡ API è°ƒç”¨ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨äº‹ä»¶é©±åŠ¨ä»¿çœŸå™¨
curl -X POST http://localhost:8001/api/simulate \
  -H "Content-Type: application/json" \
  -d '{
    "topology": { ... },
    "model": { ... },
    "inference": { ... },
    "parallelism": { ... },
    "hardware": { ... },
    "use_event_driven": true,
    "event_driven_config": {
      "max_simulated_tokens": 16,
      "enable_comm_overlap": true,
      "overlap_ratio": 0.8,
      "enable_chunked_comm": false,
      "enable_tbo": true
    }
  }'
```

### 6.2 Python ç›´æ¥è°ƒç”¨

```python
from llm_simulator.event_driven import EventDrivenSimulator, EventDrivenSimConfig

# é…ç½®
config = EventDrivenSimConfig(
    max_simulated_tokens=16,
    enable_data_transfer=True,
    enable_kv_cache=True,
    enable_comm_overlap=True,
    overlap_ratio=0.8,
    enable_chunked_comm=False,
    comm_chunk_size_mb=16.0,
    enable_tbo=True,
    pp_schedule="gpipe",
)

# åˆ›å»ºä»¿çœŸå™¨
simulator = EventDrivenSimulator(
    topology_dict=topology,
    model=model_config,
    inference=inference_config,
    parallelism=parallelism_config,
    hardware=hardware_config,
    config=config,
)

# è¿è¡Œä»¿çœŸ
result = simulator.simulate()

# è·å–ç»“æœ
print(f"Total time: {result.stats.total_run_time} ms")
print(f"TTFT: {result.stats.ttft} ms")
print(f"MFU: {result.stats.dynamic_mfu:.2%}")
```

### 6.3 æ¨¡å¼å¯¹æ¯”

| å‚æ•° | äº‹ä»¶é©±åŠ¨æ¨¡å¼ | é™æ€æ¨¡å¼ |
|------|-------------|---------|
| `use_event_driven` | `true` | `false` (é»˜è®¤) |
| ç²¾åº¦ | é«˜ï¼ˆç²¾ç¡®é‡å å»ºæ¨¡ï¼‰ | ä¸­ï¼ˆå…¬å¼ä¼°ç®—ï¼‰ |
| æ€§èƒ½ | è¾ƒæ…¢ | å¿« |
| é€‚ç”¨åœºæ™¯ | è¯¦ç»†åˆ†æã€è°ƒä¼˜ | å¿«é€Ÿè¯„ä¼°ã€å‚æ•°æ‰«æ |

---

## 9. API å‚è€ƒ

### 9.1 EventDrivenSimConfig

```python
@dataclass
class EventDrivenSimConfig:
    # åŸºç¡€é…ç½®
    max_simulated_tokens: int = 16          # æœ€å¤§æ¨¡æ‹Ÿ token æ•°
    enable_data_transfer: bool = True       # æ˜¯å¦å¯ç”¨æ•°æ®ä¼ è¾“
    enable_kv_cache: bool = True            # æ˜¯å¦å¯ç”¨ KV ç¼“å­˜

    # è®¡ç®—-é€šä¿¡é‡å ä¼˜åŒ– (Phase 2)
    enable_comm_overlap: bool = True        # æ˜¯å¦å¯ç”¨è®¡ç®—-é€šä¿¡é‡å 
    overlap_ratio: float = 0.8              # é‡å æ¯”ä¾‹ï¼ˆ0-1ï¼‰

    # åˆ†å—ä¼ è¾“ (Phase 2)
    enable_chunked_comm: bool = False       # æ˜¯å¦å¯ç”¨åˆ†å—ä¼ è¾“
    comm_chunk_size_mb: float = 16.0        # æ¯å—å¤§å°ï¼ˆMBï¼‰

    # MoE TBO ä¼˜åŒ– (Phase 2)
    enable_tbo: bool = True                 # æ˜¯å¦å¯ç”¨ MoE TBO ä¼˜åŒ–

    # è¯„ä¼°å™¨é…ç½®
    use_precise_evaluator: bool = True      # æ˜¯å¦ä½¿ç”¨ç²¾ç¡®è¯„ä¼°å™¨
    evaluation_granularity: str = "fine"    # è¯„ä¼°ç²’åº¦

    # è°ƒåº¦ç­–ç•¥
    pp_schedule: str = "gpipe"              # gpipe | 1f1b (1f1b å¾…å®ç°)

    # è°ƒè¯•é€‰é¡¹
    max_events: int = 1000000               # æœ€å¤§äº‹ä»¶æ•°
    log_events: bool = False                # æ˜¯å¦è®°å½•äº‹ä»¶æ—¥å¿—
    max_simulation_time_us: float = 1e9     # æœ€å¤§ä»¿çœŸæ—¶é—´ï¼ˆå¾®ç§’ï¼‰
```

### 7.2 HTTP API å‚æ•°

#### SimulationRequest æ–°å¢å­—æ®µ

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `use_event_driven` | bool | false | æ˜¯å¦ä½¿ç”¨äº‹ä»¶é©±åŠ¨ä»¿çœŸ |
| `event_driven_config` | object | null | äº‹ä»¶é©±åŠ¨ä»¿çœŸé…ç½® |

#### EventDrivenConfigRequest

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `max_simulated_tokens` | int | 16 | æœ€å¤§æ¨¡æ‹Ÿ token æ•° |
| `enable_data_transfer` | bool | true | æ˜¯å¦å¯ç”¨æ•°æ®ä¼ è¾“ |
| `enable_kv_cache` | bool | true | æ˜¯å¦å¯ç”¨ KV ç¼“å­˜ |
| `enable_comm_overlap` | bool | true | æ˜¯å¦å¯ç”¨è®¡ç®—-é€šä¿¡é‡å  |
| `overlap_ratio` | float | 0.8 | é‡å æ¯”ä¾‹ï¼ˆ0-1ï¼‰ |
| `enable_chunked_comm` | bool | false | æ˜¯å¦å¯ç”¨åˆ†å—ä¼ è¾“ |
| `comm_chunk_size_mb` | float | 16.0 | æ¯å—å¤§å°ï¼ˆMBï¼‰ |
| `enable_tbo` | bool | true | æ˜¯å¦å¯ç”¨ MoE TBO ä¼˜åŒ– |
| `pp_schedule` | string | "gpipe" | æµæ°´çº¿è°ƒåº¦ç­–ç•¥ |

### 7.3 EventQueue

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `push(event)` | æ·»åŠ äº‹ä»¶ï¼ŒO(log n) |
| `pop()` | å–å‡ºæœ€æ—©äº‹ä»¶ï¼ŒO(log n) |
| `peek()` | æŸ¥çœ‹æœ€æ—©äº‹ä»¶ï¼ŒO(1) |
| `push_many(events)` | æ‰¹é‡æ·»åŠ  |
| `is_empty()` | æ£€æŸ¥æ˜¯å¦ä¸ºç©º |
| `stats()` | è¿”å›ç»Ÿè®¡ä¿¡æ¯ |

### 7.4 ResourceManager

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `request_resource(chip_id, type, start, duration)` | è¯·æ±‚èµ„æº |
| `get_resource_idle_time(chip_id, type)` | è·å–èµ„æºç©ºé—²æ—¶é—´ |
| `record_bubble(chip_id, start, duration, reason)` | è®°å½•æ°”æ³¡ |
| `get_total_bubble_time(chip_id)` | è·å–æ€»æ°”æ³¡æ—¶é—´ |
| `get_bubble_breakdown()` | æŒ‰åŸå› åˆ†ç±»æ°”æ³¡ |
| `record_comm_arrival(...)` | è®°å½•é€šä¿¡åˆ°è¾¾ |
| `all_chips_ready_for_comm(...)` | æ£€æŸ¥åŒæ­¥å°±ç»ª |

### 7.5 DependencyGraph

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `add_node(node)` | æ·»åŠ ç®—å­èŠ‚ç‚¹ |
| `add_edge(src, dst, type)` | æ·»åŠ ä¾èµ–è¾¹ |
| `mark_completed(key)` | æ ‡è®°ç®—å­å®Œæˆ |
| `get_ready_successors(key)` | è·å–å°±ç»ªçš„åç»§ |
| `is_layer_complete(layer, mb)` | æ£€æŸ¥å±‚æ˜¯å¦å®Œæˆ |
| `get_entry_nodes(mb)` | è·å–å…¥å£èŠ‚ç‚¹ |

### 7.6 DependencyGraphBuilder (Phase 2 æ–°å¢)

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `build_moe_layer_with_tbo(layer_idx, layer, ...)` | æ„å»º MoE å±‚ä¾èµ–å›¾ï¼ˆæ”¯æŒ TBOï¼‰ |
| `add_edge(src, dst, dep_type)` | æ·»åŠ ä¾èµ–è¾¹ |
| `get_graph()` | è·å–æ„å»ºå®Œæˆçš„ä¾èµ–å›¾ |

---

## 10. å®ç°ç»†èŠ‚

### 10.1 äº‹ä»¶å¤„ç†æµç¨‹

```
ComputeStartEvent.handle():
    1. request_resource(COMPUTE)  â†’ è·å–å®é™…å¼€å§‹æ—¶é—´
    2. å¦‚æœæœ‰ç­‰å¾… â†’ record_bubble()
    3. gantt_builder.add_task()   â†’ è®°å½•åˆ° Gantt å›¾
    4. åˆ›å»º ComputeEndEvent       â†’ åŠ å…¥é˜Ÿåˆ—

ComputeEndEvent.handle():
    1. mark_completed()           â†’ æ ‡è®°ç®—å­å®Œæˆ
    2. get_ready_successors()     â†’ è·å–å°±ç»ªçš„åç»§
    3. ä¸ºæ¯ä¸ªåç»§åˆ›å»º StartEvent  â†’ åŠ å…¥é˜Ÿåˆ—
    4. æ£€æŸ¥æ˜¯å¦å±‚å®Œæˆ             â†’ è§¦å‘ LayerCompleteEvent
```

### 8.2 é›†åˆé€šä¿¡åŒæ­¥

```
CommStartEvent.handle():
    1. record_comm_arrival()      â†’ è®°å½•å½“å‰èŠ¯ç‰‡åˆ°è¾¾
    2. all_chips_ready_for_comm() â†’ æ£€æŸ¥æ˜¯å¦æ‰€æœ‰èŠ¯ç‰‡å°±ç»ª
       - å¦‚æœæ²¡æœ‰ï¼Œè¿”å›ç©ºåˆ—è¡¨ï¼ˆç­‰å¾…å…¶ä»–èŠ¯ç‰‡ï¼‰
       - å¦‚æœå°±ç»ªï¼Œç»§ç»­
    3. actual_start = max(arrival_times)  â†’ ä½¿ç”¨æœ€æ™šåˆ°è¾¾æ—¶é—´
    4. ä¸ºæ‰€æœ‰å‚ä¸èŠ¯ç‰‡ request_resource(NETWORK)
    5. è®°å½•ç­‰å¾…æ—¶é—´ä¸º bubble
    6. åˆ›å»º CommEndEvent
```

### 8.3 PP Stage è½¬æ¢

```
LayerCompleteEvent.handle():
    å¦‚æœæ˜¯å½“å‰ stage çš„æœ€åä¸€å±‚:
        å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ª stage:
            â†’ åˆ›å»º StageReadyEvent (ä¸‹ä¸€ stage)
        å¦åˆ™:
            â†’ åˆ›å»º BatchCompleteEvent

StageReadyEvent.handle():
    1. è®¡ç®— PP P2P é€šä¿¡å»¶è¿Ÿ
    2. æ·»åŠ é€šä¿¡ä»»åŠ¡åˆ° Gantt
    3. åˆ›å»ºä¸‹ä¸€å±‚çš„ ComputeStartEvent
```

---

## 11. æµ‹è¯•ä¸éªŒè¯

### 11.1 å•å…ƒæµ‹è¯•

```bash
cd backend
python3 -c "
from llm_simulator.event_driven import *
from llm_simulator.event_driven.event import reset_event_counter

# æµ‹è¯•äº‹ä»¶é˜Ÿåˆ—
queue = EventQueue()
reset_event_counter()
e1 = ComputeStartEvent(timestamp=10.0, chip_id='chip_0')
e2 = ComputeStartEvent(timestamp=5.0, chip_id='chip_1')
queue.push(e1)
queue.push(e2)
assert queue.peek().timestamp == 5.0
print('âœ… EventQueue test passed')

# æµ‹è¯•èµ„æºç®¡ç†
rm = ResourceManager(['chip_0'])
s1, e1 = rm.request_resource('chip_0', ResourceType.COMPUTE, 0.0, 10.0)
s2, e2 = rm.request_resource('chip_0', ResourceType.COMPUTE, 5.0, 10.0)
assert s2 == 10.0  # åº”è¯¥ç­‰å¾…
print('âœ… ResourceManager test passed')

print('All tests passed!')
"
```

### 9.2 éªŒè¯æ ‡å‡†

| åœºæ™¯ | éªŒè¯æ–¹æ³• |
|------|----------|
| å•èŠ¯ç‰‡æ— å¹¶è¡Œ | æ€»æ—¶é—´åº”ä¸é¡ºåºä»¿çœŸå®Œå…¨ç›¸ç­‰ |
| çº¯ TP å¹¶è¡Œ | è®¡ç®—æ—¶é—´ç›¸ç­‰ï¼Œé€šä¿¡æ—¶é—´ç›¸è¿‘ |
| çº¯ PP å¹¶è¡Œ | æ€»æ—¶é—´ç›¸è¿‘ï¼Œæ°”æ³¡æ¯”ä¾‹æ›´å‡†ç¡® |
| è®¡ç®—-é€šä¿¡é‡å  | Gantt å›¾åº”æ˜¾ç¤ºé‡å åŒºåŸŸ |
| MoE TBO | Dispatch å’Œ Expert åº”å¹¶è¡Œæ‰§è¡Œ |

### 9.3 å·²çŸ¥é™åˆ¶

- æš‚ä¸æ”¯æŒ 1F1B è°ƒåº¦ç­–ç•¥
- æš‚ä¸æ”¯æŒ Decode é˜¶æ®µé€ token ä»¿çœŸ
- åˆ†å—ä¼ è¾“ä»…æ”¯æŒ AllReduce/AllGather/ReduceScatter

---

## 12. é™„å½•

### A. ä¸ Vidur çš„å¯¹æ¯”

| æ–¹é¢ | Vidur | æˆ‘ä»¬çš„å®ç° |
|------|-------|-----------|
| æ‰§è¡Œæ—¶é—´é¢„æµ‹ | åŸºäº profile æ•°æ® | ç²¾ç¡®çš„ GEMM/FA2 è¯„ä¼°å™¨ âœ… |
| é€šä¿¡å»ºæ¨¡ | ç®€åŒ–æ¨¡å‹ | è¯¦ç»†çš„ AllReduce/P2P è¯„ä¼°å™¨ âœ… |
| ç¡¬ä»¶å»ºæ¨¡ | é¢„ç½®é…ç½® | çµæ´»çš„ 5 å±‚æ‹“æ‰‘ âœ… |
| äº‹ä»¶ç³»ç»Ÿ | å®Œå–„ | Phase 1 å®Œæˆ âœ… |
| Pipeline è°ƒåº¦ | åŒæ­¥ PP | Phase 2 å®ç° |
| MoE æ”¯æŒ | æœ‰é™ | è¯¦ç»†çš„ EP/TBO å»ºæ¨¡ âœ… |

### B. æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| `event.py` | ~850 | äº‹ä»¶å®šä¹‰ï¼ˆå«åˆ†å—é€šä¿¡äº‹ä»¶ï¼‰ |
| `event_queue.py` | ~120 | ä¼˜å…ˆé˜Ÿåˆ— |
| `resource.py` | ~320 | èµ„æºç®¡ç†ï¼ˆå«ç©ºé—²æ—¶é—´æŸ¥è¯¢ï¼‰ |
| `dependency.py` | ~400 | ä¾èµ–å›¾ï¼ˆå« MoE TBOï¼‰ |
| `simulator.py` | ~800 | ä»¿çœŸå™¨ä¸»ç±»ï¼ˆå«é‡å é…ç½®ï¼‰ |
| `__init__.py` | ~65 | æ¨¡å—å¯¼å‡º |
| **æ€»è®¡** | ~2555 | |

**API ç›¸å…³æ–‡ä»¶å˜æ›´**:

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `web/api.py` | ä¿®æ”¹ | æ·»åŠ äº‹ä»¶é©±åŠ¨ä»¿çœŸè°ƒç”¨ |
| `web/schemas.py` | ä¿®æ”¹ | æ·»åŠ  EventDrivenConfigRequest |

### C. æ›´æ–°æ—¥å¿—

- **2025-02-03**: Phase 2 å®Œæˆ
  - **API é›†æˆ**: äº‹ä»¶é©±åŠ¨ä»¿çœŸå™¨å¯é€šè¿‡ `/api/simulate` ç«¯ç‚¹è°ƒç”¨
  - **è®¡ç®—-é€šä¿¡å¹¶è¡Œ**: å®ç°çœŸæ­£çš„è®¡ç®—-é€šä¿¡é‡å è°ƒåº¦
    - æ–°å¢ `overlap_ratio` é…ç½®å‚æ•°
    - ComputeStartEvent æ”¯æŒæå‰è§¦å‘é€šä¿¡äº‹ä»¶
  - **åˆ†å—ä¼ è¾“**: å®ç° AllReduce åˆ†å—ä¼ è¾“
    - æ–°å¢ ChunkedCommStartEventã€ChunkedCommEndEvent äº‹ä»¶
    - ç¬¬ä¸€å—å®Œæˆå³å¯è§¦å‘åç»­è®¡ç®—
  - **MoE TBO ä¼˜åŒ–**: å®ç° Dispatch å’Œ Expert å¹¶è¡Œæ‰§è¡Œ
    - æ–°å¢ `build_moe_layer_with_tbo()` æ–¹æ³•
    - Combine ç­‰å¾… Expert å’Œ Dispatch åŒé‡ä¾èµ–
  - **æ–‡æ¡£æ›´æ–°**: æ›´æ–°æ¶æ„æ–‡æ¡£è‡³ v0.2.0

- **2025-01-28**: Phase 1 å®Œæˆ
  - å®ç°äº‹ä»¶ç³»ç»Ÿï¼ˆ7ç§äº‹ä»¶ç±»å‹ï¼‰
  - å®ç°äº‹ä»¶é˜Ÿåˆ—ï¼ˆåŸºäº heapqï¼‰
  - å®ç°èµ„æºç®¡ç†å™¨ï¼ˆè®¡ç®—/ç½‘ç»œèµ„æºï¼‰
  - å®ç°ä¾èµ–å›¾ï¼ˆç®—å­ä¾èµ–å…³ç³»ï¼‰
  - å®ç°ä»¿çœŸå™¨ä¸»ç±»
  - å¤ç”¨ç°æœ‰è¯„ä¼°å™¨å’Œ Gantt æ„å»ºå™¨
